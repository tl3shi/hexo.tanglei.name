<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css">


  <meta name="keywords" content="网络安全,程序员,黑客攻防,">





  <link rel="alternate" href="/atom.xml" title="唐磊的个人博客" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0">






<meta name="description" content="关于作者：程序猿石头(ID: tangleithu)，现任阿里巴巴技术专家，清华学渣，前大疆后端 Leader。欢迎关注，交流和指导！ 本文首发于微信公众号，原文链接，转载请全文保留。后台回复关键字 “1024” 获取程序员大厂面试指南。  背景其实这个问题我之前也看到过，刚好在前几天，洪教授在某个群里分享的一个《一些有意思的攻击手段.pdf》，我觉得这个话题还是有不少人不清楚的，今天我就准备来">
<meta name="keywords" content="网络安全,程序员,黑客攻防">
<meta property="og:type" content="article">
<meta property="og:title" content="没想到 Hash 冲突还能这么玩，你的服务中招了吗？">
<meta property="og:url" content="https://www.tanglei.name/blog/hash-collision-dos.html">
<meta property="og:site_name" content="唐磊的个人博客">
<meta property="og:description" content="关于作者：程序猿石头(ID: tangleithu)，现任阿里巴巴技术专家，清华学渣，前大疆后端 Leader。欢迎关注，交流和指导！ 本文首发于微信公众号，原文链接，转载请全文保留。后台回复关键字 “1024” 获取程序员大厂面试指南。  背景其实这个问题我之前也看到过，刚好在前几天，洪教授在某个群里分享的一个《一些有意思的攻击手段.pdf》，我觉得这个话题还是有不少人不清楚的，今天我就准备来">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://www.tanglei.name/resources/how-to-calculate-apr/dalao-01.png">
<meta property="og:image" content="https://www.tanglei.name/resources/how-to-calculate-apr/array-mem.png">
<meta property="og:image" content="https://www.tanglei.name/resources/how-to-calculate-apr/wanmei-03.png">
<meta property="og:image" content="https://www.tanglei.name/resources/how-to-calculate-apr/hash-collision-demo-04.png">
<meta property="og:image" content="https://www.tanglei.name/resources/how-to-calculate-apr/hacker-05.png">
<meta property="og:image" content="https://www.tanglei.name/resources/how-to-calculate-apr/attack-result-06.png">
<meta property="og:image" content="https://www.tanglei.name/resources/how-to-calculate-apr/php-07.png">
<meta property="og:image" content="https://www.tanglei.name/resources/how-to-calculate-apr/php-08.png">
<meta property="og:image" content="https://www.tanglei.name/resources/how-to-calculate-apr/hash-demo-request-09.png">
<meta property="og:image" content="https://www.tanglei.name/resources/how-to-calculate-apr/hash-demo-keys-10.png">
<meta property="og:image" content="https://www.tanglei.name/resources/how-to-calculate-apr/hash-demo-keys-limit-11.png">
<meta property="og:image" content="https://www.tanglei.name/resources/how-to-calculate-apr/hash-requests-ab-12.png">
<meta property="og:image" content="https://www.tanglei.name/resources/how-to-calculate-apr/hash-collision-demo-13.gif">
<meta property="og:image" content="https://www.tanglei.name/resources/how-to-calculate-apr/hash-demo-success-14.png">
<meta property="og:updated_time" content="2023-05-21T02:40:26.162Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="没想到 Hash 冲突还能这么玩，你的服务中招了吗？">
<meta name="twitter:description" content="关于作者：程序猿石头(ID: tangleithu)，现任阿里巴巴技术专家，清华学渣，前大疆后端 Leader。欢迎关注，交流和指导！ 本文首发于微信公众号，原文链接，转载请全文保留。后台回复关键字 “1024” 获取程序员大厂面试指南。  背景其实这个问题我之前也看到过，刚好在前几天，洪教授在某个群里分享的一个《一些有意思的攻击手段.pdf》，我觉得这个话题还是有不少人不清楚的，今天我就准备来">
<meta name="twitter:image" content="https://www.tanglei.name/resources/how-to-calculate-apr/dalao-01.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"always"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://www.tanglei.name/blog/hash-collision-dos.html">





  <title> 没想到 Hash 冲突还能这么玩，你的服务中招了吗？ | 唐磊的个人博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f0117177475f54027bfcaceb8d668cee";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">唐磊的个人博客</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <h1 class="site-subtitle" itemprop="description">记录我的学习、生活、工作。</h1>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://www.tanglei.name/blog/hash-collision-dos.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="tanglei">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/tx.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="唐磊的个人博客">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="唐磊的个人博客" src>
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                没想到 Hash 冲突还能这么玩，你的服务中招了吗？
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-11T00:00:00+00:00">
                2020-07-11
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/经验技巧/" itemprop="url" rel="index">
                    <span itemprop="name">经验技巧</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/blog/hash-collision-dos.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="blog/hash-collision-dos.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>关于作者：程序猿石头(ID: tangleithu)，现任阿里巴巴技术专家，清华学渣，前大疆后端 Leader。欢迎关注，交流和指导！</p>
<p>本文首发于微信公众号，<a href="https://mp.weixin.qq.com/s?__biz=MzI3OTUzMzcwNw==&amp;mid=2247486920&amp;idx=1&amp;sn=30b5c6f684dbd2748f8d14dd53ef2180&amp;chksm=eb470c2cdc30853a3317207cef2f067410b5f6c2dae7d89a29ddd558c57dd2c96c3c72521370&amp;token=553253061&amp;lang=zh_CN#rd" target="_blank" rel="noopener">原文链接</a>，转载请全文保留。后台回复关键字 “1024” 获取程序员大厂面试指南。</p>
</blockquote>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>其实这个问题我之前也看到过，刚好在前几天，洪教授在某个群里分享的一个《一些有意思的攻击手段.pdf》，我觉得这个话题还是有不少人不清楚的，今天我就准备来“实战”一把，还请各位看官轻拍。</p>
<blockquote>
<p>洪强宁（洪教授），爱因互动创始人兼 CTO，曾任豆瓣首席架构师，为中国 Python 用户组（CPUG）的创立者之一。</p>
</blockquote>
<p><img src="https://www.tanglei.name/resources/how-to-calculate-apr/dalao-01.png" alt></p>
<p>这才是真大佬，原来洪教授在宜信的时候，就有分享过这个内容，可惜当初不知道没参加。看了之后才知道原来我上一篇的文章中讲的 <a href="https://mp.weixin.qq.com/s?__biz=MzI3OTUzMzcwNw==&amp;mid=2247485939&amp;idx=1&amp;sn=cad3cf49aa345783a93ce5d9b631ba1d&amp;chksm=eb470817dc308101c95aff74fa63d530f02bef50f91ba18d4ff25b8715933a404bd03ffc8b7b&amp;token=1092973705&amp;lang=zh_CN#rd" target="_blank" rel="noopener">计时攻击（Timing Attack）</a> 也是其中的内容之一。哈哈，后面有空再研究研究继续讲其他内容。 </p>
<h2 id="Hash-冲突"><a href="#Hash-冲突" class="headerlink" title="Hash 冲突"></a>Hash 冲突</h2><p>啥叫 Hash 冲突？我们从 Hash 表（或者散列表）讲起，我们知道在一个 hash 表的查找一个元素，期望的时间复杂度为 <code>O(1)</code>，怎么做到的呢？其实就是 <code>hash()</code> 函数在起作用。 </p>
<p>初略来讲，hash 表内部实际存储还是跟数组类似，用连续的内存空间存储元素，只要通过某种方法将将要存储的元素映射为数组的下标，即可像数组一样通过下标去读取对应的元素，这也是为什么能做到 <code>O(1)</code> 的原因。 </p>
<p><img src="https://www.tanglei.name/resources/how-to-calculate-apr/array-mem.png" alt="Hash 示例"></p>
<p>以上图为例，假设是我设计的一个 hash 函数，恰好满足如下条件：</p>
<ul>
<li><code>hash(&quot;hello&quot;)=0</code>：字符串 “hello” 就存储数组下标为 0 的地方；</li>
<li><code>hash(&quot;world&quot;)=2</code>： “world” 存储数组下标为 2 的地方；</li>
<li><code>hash(&quot;tangleithu&quot;)=5</code>：”tangleithu” 存储数组下标为 5 的地方；</li>
</ul>
<p><img src="https://www.tanglei.name/resources/how-to-calculate-apr/wanmei-03.png" alt></p>
<p>目前来看一切好像很完美，但这终归是假设，我不能假设这个 hash 都很完美的将不同的字符串都映射到了不同的下标处。</p>
<p>另外来了个字符串，<code>hash(&quot;石头&quot;) = 2</code>，怎么办？这就是所谓的 “Hash 冲突”，最常见 Hash 冲突的解决方案其实就是“开链”法，其实还有比如线性试探、平方试探等等。</p>
<p>类似讲解 HashMap 的文章满大街都是，一搜一大把，本文就不详述了。为了方便读者理解，就简单来个例子。</p>
<p><img src="https://www.tanglei.name/resources/how-to-calculate-apr/hash-collision-demo-04.png" alt="Hash冲突开链法"></p>
<p>开链法如上图所示，我们存储元素的时候，存储形式为一个链表，当冲突的时候，就在链表末尾直接加冲突的元素。上图示例恰好运气比较差，字符串 <code>shitou</code>，<code>stone</code> 算出来的下标都为 2。</p>
<p>这样一来，问题大了。原本我们期望 <code>O(1)</code> 的时间复杂度查找元素，现在变成在链表中线性查找了，而如果这个时候插入 $N$ 个数据，最坏的情况下的时间复杂度就是 $O(N^2)$ 了。（这里就<strong>不讨论链表转树</strong>的情形）</p>
<p><img src="https://www.tanglei.name/resources/how-to-calculate-apr/hacker-05.png" alt="坏人乘机侵入"></p>
<p>这就又给坏人留下了想象空间。只要坏人精心设计一组要放进 hash 表的字符串，且让这些字符串的 hashcode 都一样，这就会导致 hash 冲突，结果会导致 cpu 要花费大量的时间来处理 hash 冲突，造成 DoS（Denial of Service）攻击。</p>
<p>而用 hash 表存储的情形太常见了。在 Web 服务中，一般表单的处理都是用 hash 表来保存的（后端往往要知道通过某个具体的参数 key 获取对应的参数 value）。</p>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><p>本文石头哥将以 Java SpringBoot 为例，尝试进行一次攻击。</p>
<p>不过别以为这种 “Hash 冲突 DoS” 以为只有 Java 才有哦，什么 Python，Apache Tomcat/Jetty，PHP 之类都会有这个问题的。其实早在 2011 年年末的时候就被大量爆出了，有的框架陆陆续续有一些改进和修复。详细情况可以看这篇文章：<a href="http://ocert.org/advisories/ocert-2011-003.html" title="oCERT-2011-003 multiple implementations denial-of-service via hash algorithm collision" target="_blank" rel="noopener">oCERT-2011-003 multiple implementations denial-of-service via hash algorithm collision</a>。</p>
<p>这里，咱们给列举其中一个 Apatch Tomcat，来自 <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2011-4858" title="CVE-2011-4858" target="_blank" rel="noopener">CVE-2011-4858</a>。</p>
<blockquote>
<p>Apache Tomcat before 5.5.35, 6.x before 6.0.35, and 7.x before 7.0.23 computes hash values for form parameters without restricting the ability to trigger hash collisions predictably, which allows remote attackers to cause a denial of service (CPU consumption) by sending many crafted parameters.</p>
</blockquote>
<p>下面截图来自洪教授的 PPT，但内容的具体来源不详了（尝试找了下，没找到），大家参考参考就好。 </p>
<p><img src="https://www.tanglei.name/resources/how-to-calculate-apr/attack-result-06.png" alt="实现 hash 冲突 DoS 攻击所须带宽"></p>
<p>左边表示用不同的语言（框架）实现这种攻击所需要的带宽，右边是攻击的 cpu 目标。可以看出，实施这种攻击成本其实挺低的（后文石头的试验也佐证了这一点）。</p>
<p><img src="https://www.tanglei.name/resources/how-to-calculate-apr/php-07.png" alt="PHP是世界上最好的语言"></p>
<p>不得不说 “PHP 是世界上最好的编程语言”（大家别打架），还是有一定道理的，哈哈哈哈哈哈 😝（一张图还不够，再加一张）</p>
<p><img src="https://www.tanglei.name/resources/how-to-calculate-apr/php-08.png" alt="PHP是世界上最好的语言"></p>
<p>上面的语言排序，不一定对，大家参考一下即可，不用纠结具体的准确性。</p>
<p>其实要验证，方法当然也相对简单，只要找出产生冲突的不同字符串即可，具体语言可能不一样。</p>
<h2 id="talk-is-cheap"><a href="#talk-is-cheap" class="headerlink" title="talk is cheap"></a>talk is cheap</h2><p>“talk is cheap”，现在跟着我来尝试进行一次攻击吧，本人用自己的笔记本进行试验（配置：MBP 13-inch，2.5 GHz Intel Core i7，16 GB 2133 MHz LPDDR3）。</p>
<p>首先构造一把 hash 冲突的字符串，下面代码是 hash 冲突的字符串对的实例，后面的其实可以通过前面排列组合生成。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">System.out.println(<span class="string">"Aa"</span>.hashCode());</span><br><span class="line">System.out.println(<span class="string">"BB"</span>.hashCode());</span><br><span class="line">System.out.println(<span class="string">"BBBBBBBBBBBBBBBBBBBBBBBBAaBBBBAa"</span>.hashCode());</span><br><span class="line">System.out.println(<span class="string">"BBBBBBBBBBBBBBBBBBBBBBBBAaBBBBBB"</span>.hashCode());</span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="number">2112</span></span><br><span class="line"><span class="number">2112</span></span><br><span class="line"><span class="number">2067858432</span></span><br><span class="line"><span class="number">2067858432</span></span><br></pre></td></tr></table></figure>
<p>具体生成过程本文不详述了，感兴趣可以看看 StackOverflow 上的这篇文章 <a href="https://stackoverflow.com/questions/8669946/application-vulnerability-due-to-non-random-hash-functions" title="Application vulnerability due to Non Random Hash Functions" target="_blank" rel="noopener">Application vulnerability due to Non Random Hash Functions</a>，或者参考耗子叔的这篇 <a href="https://coolshell.cn/articles/6424.html" title="Hash Collision DoS 问题" target="_blank" rel="noopener">Hash Collision DoS 问题</a>。</p>
<p>然后我启用一个 SpringBoot（2.2.2.RELEASE） 的 Web 服务，JDK 1.8（其实用 1.7 效果更明显）。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/hash"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hash</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Demo，简单返回参数大小和其对应hashCode</span></span><br><span class="line">    <span class="keyword">int</span> size = request.getParameterMap().size();</span><br><span class="line">    String key = (String)(request.getParameterMap().keySet().toArray())[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">return</span> String.format(<span class="string">"size=%s, hashCode=%s"</span>, size, key.hashCode());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先试水一把（如下图），看看基本功能正常，用 curl 发送请求即可，然后将 post 的字段放在文件里面（太长也只能放文件中）。</p>
<p><img src="https://www.tanglei.name/resources/how-to-calculate-apr/hash-demo-request-09.png" alt></p>
<p>生成的字符串不够的话，还可以增加并发请求，可以借用类似 “Apache Benchmarking” 压测的工具发送请求，我之前也有一篇文章介绍了这个命令 <a href="https://mp.weixin.qq.com/s?__biz=MzI3OTUzMzcwNw==&amp;mid=2247485113&amp;idx=2&amp;sn=9a85da7a595cbad2960952fd47b89e0a&amp;chksm=eb47075ddc308e4b9137c4e045510afcb8bb65e83a21cae6558150ca2c8be74105ce7bc22725&amp;token=1092973705&amp;lang=zh_CN#rd" target="_blank" rel="noopener">性能测试工具 - ab 简单应用</a>，感兴趣的可以参考一下。 </p>
<p><img src="https://www.tanglei.name/resources/how-to-calculate-apr/hash-demo-keys-10.png" alt="冲突的 hashcode 一样"></p>
<p>打个断点看看效果，如上图所示，确实所有的 hash 值都是一样的。不过一次请求好像并没有影响我电脑 cpu 的明显变化。 </p>
<p>我测试的字符串已经是 <code>29859</code> 个了，正准备生成更多的冲突的字符串进行尝试时，结果仔细一看才发现请求被截断了，请求返回的参数 size 大小为 10000。原来 SpringBoot 内置的 tomcat 给做了手脚，看下图，因为默认的请求的参数个数大小被限制成 10000 了。 </p>
<blockquote>
<p>More than the maximum number of request parameters (GET plus POST) for a single request ([10,000]) were detected. Any parameters beyond this limit have been ignored. To change this limit, set the maxParameterCount attribute on the Connector.</p>
</blockquote>
<p><img src="https://www.tanglei.name/resources/how-to-calculate-apr/hash-demo-keys-limit-11.png" alt="post参数数量被限制"></p>
<p>一种方法当然是去修改这个请求参数个数的限制。另外其实可以尝试用 JDK 1.7 去验证，应该效果会更好（原因，聪明的读者你肯定知道吧？）。这里石头哥就懒得去折腾了，直接尝试以量来取胜，用前文说的 ab 进行并发提交请求，然后观察效果。 </p>
<p>这是我用如下参数跑的压测结果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ab -c 200 -n 100000 -p req.txt &apos;localhost:8080/hash&apos;</span><br></pre></td></tr></table></figure>
<p>压测的结果如图所示：</p>
<p><img src="https://www.tanglei.name/resources/how-to-calculate-apr/hash-requests-ab-12.png" alt="ab 压测 hash 冲突结果"></p>
<p>然后我们来看看 CPU 的变化情况，特意录屏做了个动图，可以看出还是相对比较明显的。从基本不占用 cpu 到 39.6%，然后突然就涨到 158% 了。</p>
<p>实际试验中这个过程没有一直持续（上面是重试过程中抓到的其中一次），一方面因为本人用的 JDK 1.8，本来冲突后的查找过程已经优化了，可能效果并不明显，另外也猜测可能会有一些 cache 之类的优化吧，另外对于 10000 的量也还不够？具体我也没有深究了，感兴趣的读者可以去尝试一下玩玩。</p>
<p><img src="https://www.tanglei.name/resources/how-to-calculate-apr/hash-collision-demo-13.gif" alt="hash-collision-demo动图"></p>
<p>实验算成功了吧。 </p>
<p><img src="https://www.tanglei.name/resources/how-to-calculate-apr/hash-demo-success-14.png" alt="实验成功就是拽"></p>
<p>我这还是单机，要是多搞几个 client，不分分钟把 Web 服务搞死啊。</p>
<h2 id="防御方法"><a href="#防御方法" class="headerlink" title="防御方法"></a>防御方法</h2><p>上面实验算是成功了，那么防御方法呢？其实就是：</p>
<ul>
<li>改 hash 算法算一种了；例如像有的用随机算法作为 hash 函数的情况，可以用不同的随机种子尝试生成；但其实没有完美的 hash 算法的。 </li>
<li>本文实验中的也遇到这个了，就是要限制请求的参数个数，以及请求长度。在不影响业务的情况下，限制尽可能更小；</li>
<li>上 WAF（Web Application Firewall），用专业的防火墙清洗流量。</li>
</ul>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><blockquote>
<p>注意：本文上文实验还不够严谨，严格意义上来说，还需要加个对比实验（单纯高并发场景的负载），不能证明 cpu 高就是因为 hash 冲突导致的。不过，道理懂了，剩下的，就教给你去实验吧，最好用 JDK1.7 实验哦。记得把结果告诉我。</p>
</blockquote>
<p>本文只供学习交流使用，请大家不要轻易尝试线上服务，不要轻易尝试线上服务，不要轻易尝试线上服务。</p>
<p>本人才疏学浅，如果有不对的地方，还望大家指出。</p>
<p>原创真心不易，希望你能帮我个小忙呗，如果本文内容你觉得有所启发，有所收获，请帮忙点个“在看”呗（若不好意思暴露，你起码点个赞嘛😝），转发分享就更好啦，这将是我继续输出更多优质文章的最强动力。</p>

      
    </div>

    <div>
      
        
<div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="/resources/wechat-tangleithu-codershitou.jpg" alt="tanglei wechat" style="width: 400px; max-width: 100%;">
    <div>欢迎扫码加入互联网大厂内推群 & 技术交流群，一起学习、共同进步</div>
</div>


      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/网络安全/" rel="tag"># 网络安全</a>
          
            <a href="/tags/程序员/" rel="tag"># 程序员</a>
          
            <a href="/tags/黑客攻防/" rel="tag"># 黑客攻防</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/timing-attack-of-safe-equals.html" rel="next" title="这 10 行比较字符串相等的代码给我整懵逼了，不信你也来看看">
                <i class="fa fa-chevron-left"></i> 这 10 行比较字符串相等的代码给我整懵逼了，不信你也来看看
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/blog/shuffle-algorithm.html" rel="prev" title="面试官：会玩牌吧？给我讲讲洗牌算法和应用场景吧！">
                面试官：会玩牌吧？给我讲讲洗牌算法和应用场景吧！ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/tx.jpg" alt="tanglei">
          <p class="site-author-name" itemprop="name">tanglei</p>
          <p class="site-description motion-element" itemprop="description">码农 @ 阿里云, 毕业于CSU && THU,  曾工作于大疆(DJI), 宜信大数据创新中心, <a href="http://www.tencent.com/zh-cn/index.shtml" target="_blank">腾讯</a> && <a href="http://www.umeng.com/" target="_blank">友盟</a>.  &nbsp; <a href="/about/"> MORE </a></p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">518</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">153</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="/resources/tl3shi-wechat.png" target="_blank" title="Wechat">
                  
                    <i class="fa fa-fw fa-weixin"></i>
                  
                  Wechat
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/tl3shi" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/tangleithu" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#背景"><span class="nav-number">1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hash-冲突"><span class="nav-number">2.</span> <span class="nav-text">Hash 冲突</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实战"><span class="nav-number">3.</span> <span class="nav-text">实战</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#talk-is-cheap"><span class="nav-number">4.</span> <span class="nav-text">talk is cheap</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#防御方法"><span class="nav-number">5.</span> <span class="nav-text">防御方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#最后"><span class="nav-number">6.</span> <span class="nav-text">最后</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2010 - 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">tanglei</span>
   
  <span class="author" itemprop="copyrightHolder">
      - 渝ICP备16013386号 
  </span>
 
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'hexo-tanglei';
      var disqus_identifier = 'blog/hash-collision-dos.html';

      var disqus_title = "没想到 Hash 冲突还能这么玩，你的服务中招了吗？";


      function run_disqus_script(disqus_script) {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');

      
        var disqus_config = function () {
            this.page.url = disqus_url;
            this.page.identifier = disqus_identifier;
            this.page.title = disqus_title;
        };
        run_disqus_script('embed.js');
      

    </script>
  







  
  

  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  


</body>
</html>
