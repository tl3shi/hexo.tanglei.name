<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Java,Bug,">





  <link rel="alternate" href="/atom.xml" title="唐磊的个人博客" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0">






<meta name="description" content="这其实是去年就踩的一个坑了, 之前又踩到一个类似的, 于是想起在这里来分享一下. 背景是这样的:  我们的项目依赖于一个外部服务, 该外部服务提供 REST 接口供我方调用, 本地测试和测试环境都没有问题, 但是一上生产环境就发现网络不通. (本地测试/测试环境, 生产环境网络通过不通的域名访问该外部服务), 且在生产环境通过 curl 等命令能够正常调用对方接口. 最终排查原因出现在域名上, 在">
<meta name="keywords" content="Java,Bug">
<meta property="og:type" content="article">
<meta property="og:title" content="JDK(java.net.URL) 中的 一个 &quot;bug&quot;">
<meta property="og:url" content="https://www.tanglei.name/blog/conflicts-between-java-net-url-and-java-net-uri-when-dealing-with-hostname-contains-underscore.html">
<meta property="og:site_name" content="唐磊的个人博客">
<meta property="og:description" content="这其实是去年就踩的一个坑了, 之前又踩到一个类似的, 于是想起在这里来分享一下. 背景是这样的:  我们的项目依赖于一个外部服务, 该外部服务提供 REST 接口供我方调用, 本地测试和测试环境都没有问题, 但是一上生产环境就发现网络不通. (本地测试/测试环境, 生产环境网络通过不通的域名访问该外部服务), 且在生产环境通过 curl 等命令能够正常调用对方接口. 最终排查原因出现在域名上, 在">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://www.tanglei.name/resources/conflicts-between-java-net-url-and-java-net-uri-when-dealing-with-hostname-contains-underscore/nonsense.jpg">
<meta property="og:updated_time" content="2022-01-09T16:47:22.986Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JDK(java.net.URL) 中的 一个 &quot;bug&quot;">
<meta name="twitter:description" content="这其实是去年就踩的一个坑了, 之前又踩到一个类似的, 于是想起在这里来分享一下. 背景是这样的:  我们的项目依赖于一个外部服务, 该外部服务提供 REST 接口供我方调用, 本地测试和测试环境都没有问题, 但是一上生产环境就发现网络不通. (本地测试/测试环境, 生产环境网络通过不通的域名访问该外部服务), 且在生产环境通过 curl 等命令能够正常调用对方接口. 最终排查原因出现在域名上, 在">
<meta name="twitter:image" content="https://www.tanglei.name/resources/conflicts-between-java-net-url-and-java-net-uri-when-dealing-with-hostname-contains-underscore/nonsense.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"always"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://www.tanglei.name/blog/conflicts-between-java-net-url-and-java-net-uri-when-dealing-with-hostname-contains-underscore.html">





  <title> JDK(java.net.URL) 中的 一个 "bug" | 唐磊的个人博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f0117177475f54027bfcaceb8d668cee";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">唐磊的个人博客</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <h1 class="site-subtitle" itemprop="description">记录我的学习、生活、工作。</h1>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://www.tanglei.name/blog/conflicts-between-java-net-url-and-java-net-uri-when-dealing-with-hostname-contains-underscore.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="tanglei">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/tx.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="唐磊的个人博客">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="唐磊的个人博客" src>
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                JDK(java.net.URL) 中的 一个 "bug"
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-31T00:00:00+00:00">
                2017-05-31
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/经验技巧/" itemprop="url" rel="index">
                    <span itemprop="name">经验技巧</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/blog/conflicts-between-java-net-url-and-java-net-uri-when-dealing-with-hostname-contains-underscore.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="blog/conflicts-between-java-net-url-and-java-net-uri-when-dealing-with-hostname-contains-underscore.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>这其实是去年就踩的一个坑了, 之前又踩到一个类似的, 于是想起在这里来分享一下. 背景是这样的: </p>
<p>我们的项目依赖于一个外部服务, 该外部服务提供 REST 接口供我方调用, 本地测试和测试环境都没有问题, 但是一上生产环境就发现网络不通. (本地测试/测试环境, 生产环境网络通过不通的域名访问该外部服务), 且在生产环境通过 <code>curl</code> 等命令能够正常调用对方接口. 最终排查原因出现在域名上, 在生产环境中通过 java 的 httpclient (该第三方包依赖<code>java.net.URI</code>) 调用未发出请求. 该域名形如  <code>http://test_1.tanglei.name</code> </p>
<p>下面来重现一下该案例. </p>
<h2 id="server-端准备"><a href="#server-端准备" class="headerlink" title="server 端准备"></a>server 端准备</h2><p>这里用 nginx 模拟了一下 上文提到的 REST 服务, 假设调用正常返回 <code>&quot;Hello, World\n&quot;</code>, nginx 配置如下: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen    80;</span><br><span class="line">    server_name test_1.tanglei.name;</span><br><span class="line">    location /testurl &#123;</span><br><span class="line">        add_header Content-Type &apos;text/plain; charset=utf-8&apos;;</span><br><span class="line">        return 200 &quot;Hello, World\n&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="client"><a href="#client" class="headerlink" title="client"></a>client</h2><h3 id="curl-命令"><a href="#curl-命令" class="headerlink" title="curl 命令"></a>curl 命令</h3><p><code>curl</code> 请求</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@VM_77_245_centos vhost]<span class="comment"># curl -i "http://test_1.tanglei.name/testurl"</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx</span><br><span class="line">Date: Wed, 31 May 2017 09:53:01 GMT</span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line">Content-Length: 13</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Type: text/plain; charset=utf-8</span><br><span class="line"></span><br><span class="line">Hello, World</span><br><span class="line">[root@VM_77_245_centos vhost]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>请忽略上面的两个重复的header(nginx 默认有一个header, 上面的配置又加了一个), 可以点击这里查看效果 <a href="http://test_1.tanglei.name/testurl" target="_blank" rel="noopener">http://test_1.tanglei.name/testurl</a>. （对，我解析了这个域名）</p>
<h3 id="python-requests"><a href="#python-requests" class="headerlink" title="python requests"></a>python requests</h3><p>python 也是调用OK</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> requests</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.get(<span class="string">"http://test_1.tanglei.name/testurl"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.text</span><br><span class="line"><span class="string">u'Hello, World\n'</span></span><br></pre></td></tr></table></figure>
<h3 id="java"><a href="#java" class="headerlink" title="java"></a>java</h3><p>我们来看一下通过 Java 调用. </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> String <span class="title">getContent</span><span class="params">(java.net.URL url)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    java.net.URLConnection conn = url.openConnection();</span><br><span class="line">    java.io.InputStreamReader in = <span class="keyword">new</span> java.io.InputStreamReader(conn.getInputStream(), <span class="string">"utf-8"</span>);</span><br><span class="line">    java.io.BufferedReader reader = <span class="keyword">new</span> java.io.BufferedReader(in);    </span><br><span class="line">    StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    <span class="keyword">int</span> c = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> ((c = reader.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">        sb.append((<span class="keyword">char</span>)c);</span><br><span class="line">    &#125;</span><br><span class="line">    reader.close();</span><br><span class="line">    in.close();</span><br><span class="line">    String response = sb.toString();</span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的这个方法 <code>String getContent(java.net.URL url)</code> 传入一个构造好的 <code>java.net.URL</code> 然后 get 请求, 并以 <code>String</code> 方式返回 response.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String srcUrl = <span class="string">"http://test_1.tanglei.name/testurl"</span>;</span><br><span class="line">java.net.URL url = <span class="keyword">new</span> java.net.URL(srcUrl);</span><br><span class="line">System.out.println(<span class="string">"\nurl result:\n"</span> + getContent(url)); <span class="comment">// OK</span></span><br></pre></td></tr></table></figure>
<p>上面的语句输出正常, 结果如下 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">url result:</span><br><span class="line">Hello, World</span><br></pre></td></tr></table></figure>
<p>换 <code>java.net.URI</code> 试试? (这里不展开讲URL和URI的区别联系了, 可以简单的认为URL是URI的一个子集, 详细的可参考 <a href="https://www.ibm.com/developerworks/cn/xml/x-urlni.html" target="_blank" rel="noopener">URI、URL 和 URN</a>, <a href="https://en.wikipedia.org/wiki/Uniform_Resource_Identifier" target="_blank" rel="noopener">wiki URI</a>)<br>直接通过<code>java.net.URI</code>构造, 再调用 <code>URI.toURL</code> 得到URL，调用同样正常。关键的来了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">URI(String scheme, String host, String path, String fragment)</span><br><span class="line">Constructs a hierarchical URI from the given components.</span><br></pre></td></tr></table></figure>
<p>我用这个方法构造<code>URI</code>, 会构造失败(详细异常信息见文末)。 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> java.net.URI(uri.getScheme(), uri.getHost(), uri.getPath(), <span class="keyword">null</span>) error: protocol = http host = <span class="keyword">null</span></span><br><span class="line"><span class="keyword">new</span> java.net.URI(url.getProtocol(), url.getHost(), url.getPath(), <span class="keyword">null</span>) error: Illegal character in hostname at index <span class="number">11</span>: http:<span class="comment">//test_1.tanglei.name/testurl</span></span><br></pre></td></tr></table></figure>
<p>所以问题发现了, 我们的项目中依赖的第三方httpclient包底层用到了 <code>java.net.URI</code>, 恰好在 <code>java.net.URI</code> 中是不允许以下划线(<code>_</code>)作为 <code>hostname</code> 字段的。 即这个表达式 <code>uri.getHost() == uri.toURL().getHost()</code> 不一定成立。(<strong>update</strong>: Scala写惯了, 以Java来理解, 这句话还有问题, 这里想表达的是两个字符串是否 <strong>equals</strong>)</p>
<p>这是 JDK 的 Bug 吗？</p>
<p>从官网上还真找到了关于包含下划线作为hostname的bug提交ticket, 戳这里 <a href="http://bugs.java.com/bugdatabase/view_bug.do?bug_id=8132508" target="_blank" rel="noopener">JDK-8132508 : Bug JDK-8029354 reproduces with underscore in hostname</a> ， 然后发现该 “bug” reporter 的情况貌似跟我的差不多，只不过引爆bug的点不一样. </p>
<p>该 “bug” reviewer 最后以 “Not an Issue” 关闭，给出的理由是</p>
<blockquote>
<p>RFC 952 disallows _ underscores in hostnames. So, this is not a bug. </p>
</blockquote>
<p>确实, <a href="https://tools.ietf.org/html/rfc952" target="_blank" rel="noopener">rfc952</a> 明确说了域名只能由 字母 <code>(A-Z)</code>, 数字<code>(0-9)</code>, 减号 <code>(-)</code>, 和 点 <code>(.)</code> 组成。</p>
<p>那 OK 吧, 既然明确规定了 hostname 不能包含下划线, 为啥 <code>java.net.URL</code> 确允许呢? 造成 <code>java.net.URI</code> 和 <code>java.net.URL</code> 在处理 hostname 时的标准不一致, 且本身 <code>java.net.URI</code> 在构造的时候也带了 “有色”眼镜, 通过静态方法 <code>java.net.URI.create(String)</code> 或者通过带1个参数的构造方法 <code>java.net.URI(String)</code> 都能成功构造出 URI 的实例，通过带4个参数的构造方法就不能构造了. (同一个url字符串). </p>
<p>要知道, 在 coding 过程中，<strong>尽早</strong>反馈异常信息更有利于软件开发持续迭代的过程. 我们在开发过程中也应该遵循这一点原则。 </p>
<h3 id="JDK-java-net-URL-中的-“bug”"><a href="#JDK-java-net-URL-中的-“bug”" class="headerlink" title="JDK(java.net.URL) 中的 “bug” ?"></a>JDK(java.net.URL) 中的 “bug” ?</h3><p>我记得去年我就到JDK官网提交了一个 bug, 大意是说 <code>java.net.URI</code> 和 <code>java.net.URL</code> 在处理hostname的时候标准不一致, 容易使开发人员埋藏一些潜在的bug. 不过当初提交之后就没有反应了。 (为啥没有收到相应的邮件通知 report 状态? 也bug了?)</p>
<p>直到前两天, 又把该问题提交到 <a href="https://stackoverflow.com/questions/44226003/conflicts-between-java-net-url-and-java-net-uri-when-dealing-with-hostname-conta" target="_blank" rel="noopener">stackoverflow</a>.</p>
<blockquote>
<p>I am wondering, if hostname with underscore is not valid, why the result is differrent between java.net.URI and java.net.URL? Is it a bug or a feature? Here is the example.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java.net.URL url = new java.net.URL(&quot;http://test_1.tanglei.name&quot;);</span><br><span class="line">System.out.println(url.getHost()); //test_1.tanglei.name</span><br><span class="line">java.net.URI uri = new java.net.URI(&quot;http://test_1.tanglei.name&quot;);</span><br><span class="line">System.out.println(uri.getHost()); //null</span><br></pre></td></tr></table></figure>
<p>过了1天才发现原来我去年提交的bug有更新状态了. bug 详细信息见 <a href="http://bugs.java.com/bugdatabase/view_bug.do?bug_id=8170265" target="_blank" rel="noopener">JDK-8170265 : underscore is allowed in java.net.URL while not in java.net.URI</a>, (<a href="https://bugs.openjdk.java.net/browse/JDK-8170265" target="_blank" rel="noopener">openjdk JDK-8170265</a> 更详细）。 然而该 bug 状态也以 “Not an Issue” 告终.<br>不过其中一个reviewer还是承认了这个问题, 说的是 <code>java.net.URL</code> 遵循的是 <code>RFC 2396</code> 规范, 确实不允许含有下划线的hostname，<code>java.net.URI</code> 做到了， 而 <code>java.net.URL</code> 没有做到。</p>
<blockquote>
<p>As per RFC 2396:<br>“Hostnames take the form described in Section 3 of [RFC1034] and<br>   Section 2.1 of [RFC1123]: a sequence of domain labels separated by<br>   “.”, each domain label starting and ending with an alphanumeric<br>   character and possibly also containing “-“ characters.  The rightmost<br>   domain label of a fully qualified domain name will never start with a<br>   digit, thus syntactically distinguishing domain names from IPv4<br>   addresses, and may be followed by a single “.” if it is necessary to<br>   distinguish between the complete domain name and any local domain.<br>   To actually be “Uniform” as a resource locator, a URL hostname should<br>   be a fully qualified domain name.  In practice, however, the host<br>   component may be a local domain literal.”</p>
</blockquote>
<blockquote>
<p>URI class is following the above, but URL class doesn’t seem to follow the same rules.</p>
</blockquote>
<blockquote>
<p>To reproduce the issue , run the attached test case.<br>Following is the output on various JDK versions:<br>JDK 8 - Fail<br>JDK 8u112 - Fail<br>JDK 8u122-ea - Fail<br>JDK 9-ea + 141 - Fail</p>
</blockquote>
<p>重点来了, 然后, 被上一级 reviewer 直接个毙了. 原因是 <code>java.net.URL</code> 构造方法中，api文档中说了本来也不会做验证即 <code>No validation of the inputs is performed by this constructor.</code> <a href="https://docs.oracle.com/javase/8/docs/api/java/net/URL.html" target="_blank" rel="noopener">在线 api doc 戳这里</a> (可以点连接，进去搜索关键字 “No validation”)</p>
<blockquote>
<p>The constructors of URL class (e.g., <a href="http://download.java.net/java/jdk9/docs/api/java/net/URL.html#URL-java.lang.String-java.lang.String-java.lang.String-" target="_blank" rel="noopener">http://download.java.net/java/jdk9/docs/api/java/net/URL.html#URL-java.lang.String-java.lang.String-java.lang.String-</a>) specifically mention about the validation: </p>
</blockquote>
<blockquote>
<p>“No validation of the inputs is performed by this constructor.” </p>
</blockquote>
<blockquote>
<p>So not throwing an exception isn’t an issue here.</p>
</blockquote>
<p><img src="https://www.tanglei.name/resources/conflicts-between-java-net-url-and-java-net-uri-when-dealing-with-hostname-contains-underscore/nonsense.jpg" alt></p>
<p>其实就算 “No validation of the inputs is performed by this constructor.” 是合理的, 里面也只有3个构造函数有这样的说明，按照这样的逻辑是不是说另外的构造函数有验证呢….. (示例中的默认的构造函数都没有说呀)</p>
<p><a href="http://www.docjar.com/html/api/java/net/URL.java.html" target="_blank" rel="noopener">这里有java.net.URL 的源码</a>, 看兴趣的同学可以看看.  </p>
<p>恩，以上就是结论了。<br>不过，反正我自己感觉目前Java API 关于这里的设计不太合理, 欢迎大家讨论。</p>
<p>对 <a href="https://stackoverflow.com/questions/44226003/conflicts-between-java-net-url-and-java-net-uri-when-dealing-with-hostname-conta?answertab=active#tab-top" target="_blank" rel="noopener">SO</a>上的这个答案还是表示赞同, 哈哈. </p>
<blockquote>
<p>The review is somewhat terse, but the reviewer’s point is the URL constructor is behaving in accordance with its specification. Since the specification explicitly states that no validation is performed, this is not a bug in the code. This is indisputable.</p>
</blockquote>
<blockquote>
<p>What he didn’t spell out is that fixing this inconsistency (by changing the URL class specification) would break lots of peoples’ 20+ year old code Java code. That would be a really bad idea. It can’t happen.</p>
</blockquote>
<blockquote>
<p>So … this inconsistency is a “feature”.</p>
</blockquote>
<h2 id="附件"><a href="#附件" class="headerlink" title="附件"></a>附件</h2><p>附上本文示例代码 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestURL</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">conflicts</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String urlSrc = <span class="string">"http://test_1.tanglei.name/testurl"</span>;</span><br><span class="line">        java.net.URL url = <span class="keyword">new</span> java.net.URL(urlSrc);</span><br><span class="line">        System.out.println(url.getHost()); <span class="comment">//test_1.tanglei.name</span></span><br><span class="line">        System.out.println(url.getProtocol()); <span class="comment">//http</span></span><br><span class="line">        System.out.println(url.getPath()); <span class="comment">// /testurl</span></span><br><span class="line">        java.net.URI uri = <span class="keyword">new</span> java.net.URI(urlSrc);</span><br><span class="line">        <span class="comment">//Typo System.err.println("uri.getHost() == uri.toURL().getHost() is: " + (uri.getHost() == uri.toURL().getHost()));</span></span><br><span class="line">        <span class="comment">//Attention: NullPointerException</span></span><br><span class="line">        System.err.println(<span class="string">"uri.toURL().getHost().equals(uri.getHost())) is: "</span> + (uri.toURL().getHost().equals(uri.getHost())));</span><br><span class="line">        System.out.println(uri.getHost()); <span class="comment">//null    </span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> String <span class="title">getContent</span><span class="params">(java.net.URL url)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        java.net.URLConnection conn = url.openConnection();</span><br><span class="line">        java.io.InputStreamReader in = <span class="keyword">new</span> java.io.InputStreamReader(conn.getInputStream(), <span class="string">"utf-8"</span>);</span><br><span class="line">        java.io.BufferedReader reader = <span class="keyword">new</span> java.io.BufferedReader(in);    </span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">int</span> c = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> ((c = reader.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">            sb.append((<span class="keyword">char</span>)c);</span><br><span class="line">        &#125;</span><br><span class="line">        reader.close();</span><br><span class="line">        in.close();</span><br><span class="line">        String response = sb.toString();</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        conflicts();</span><br><span class="line">        String srcUrl = <span class="string">"http://test_1.tanglei.name/testurl"</span>;</span><br><span class="line">        java.net.URL url = <span class="keyword">new</span> java.net.URL(srcUrl);</span><br><span class="line">        System.out.println(<span class="string">"\nurl result:\n"</span> + getContent(url)); <span class="comment">// OK</span></span><br><span class="line">        System.out.println(<span class="string">"\nurl.toURI.toURL result: \n"</span> + getContent(url.toURI().toURL())); <span class="comment">// OK</span></span><br><span class="line">        java.net.URI uri = <span class="keyword">new</span> java.net.URI(srcUrl);</span><br><span class="line">        System.out.println(<span class="string">"\nuri.toURL result: \n"</span> + getContent(uri.toURL())); <span class="comment">// OK</span></span><br><span class="line">        java.net.URI uri2 = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            uri2 = <span class="keyword">new</span> java.net.URI(uri.getScheme(), uri.getHost(), uri.getPath(), <span class="keyword">null</span>); <span class="comment">//throw Exception: java.lang.IllegalArgumentException: protocol = http host = null</span></span><br><span class="line">            System.out.println(<span class="string">"\nuri2.toURL result:\n"</span> + getContent(uri2.toURL())); </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            System.err.println(<span class="string">"new java.net.URI(uri.getScheme(), uri.getHost(), uri.getPath(), null) error: "</span> + ex.getMessage());</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            uri2 = <span class="keyword">new</span> java.net.URI(url.getProtocol(), url.getHost(), url.getPath(), <span class="keyword">null</span>); <span class="comment">//throw Exception: java.lang.IllegalArgumentException: protocol = http host = null</span></span><br><span class="line">            System.out.println(<span class="string">"\nuri2.toURL result:\n"</span> + getContent(uri2.toURL())); </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            System.err.println(<span class="string">"new java.net.URI(url.getProtocol(), url.getHost(), url.getPath(), null) error: "</span> + ex.getMessage());</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">test_1.tanglei.name</span><br><span class="line">http</span><br><span class="line">/testurl</span><br><span class="line">uri.getHost() == uri.toURL().getHost() is: <span class="keyword">false</span></span><br><span class="line"><span class="keyword">null</span></span><br><span class="line"></span><br><span class="line">url result:</span><br><span class="line">Hello, World</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url.toURI.toURL result:</span><br><span class="line">Hello, World</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">uri.toURL result:</span><br><span class="line">Hello, World</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> java.net.URI(uri.getScheme(), uri.getHost(), uri.getPath(), <span class="keyword">null</span>) error: protocol = http host = <span class="keyword">null</span></span><br><span class="line">java.lang.IllegalArgumentException: protocol = http host = <span class="keyword">null</span></span><br><span class="line">	at sun.net.spi.DefaultProxySelector.select(DefaultProxySelector.java:<span class="number">176</span>)</span><br><span class="line">	at sun.net.www.protocol.http.HttpURLConnection.plainConnect0(HttpURLConnection.java:<span class="number">1097</span>)</span><br><span class="line">	at sun.net.www.protocol.http.HttpURLConnection.plainConnect(HttpURLConnection.java:<span class="number">997</span>)</span><br><span class="line">	at sun.net.www.protocol.http.HttpURLConnection.connect(HttpURLConnection.java:<span class="number">931</span>)</span><br><span class="line">	at sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:<span class="number">1511</span>)</span><br><span class="line">	at sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:<span class="number">1439</span>)</span><br><span class="line">	at TestURL.getContent(TestURL.java:<span class="number">14</span>)</span><br><span class="line">	at TestURL.main(TestURL.java:<span class="number">38</span>)</span><br><span class="line"><span class="keyword">new</span> java.net.URI(url.getProtocol(), url.getHost(), url.getPath(), <span class="keyword">null</span>) error: Illegal character in hostname at index <span class="number">11</span>: http:<span class="comment">//test_1.tanglei.name/testurl</span></span><br><span class="line">java.net.URISyntaxException: Illegal character in hostname at index <span class="number">11</span>: http:<span class="comment">//test_1.tanglei.name/testurl</span></span><br><span class="line">	at java.net.URI$Parser.fail(URI.java:<span class="number">2848</span>)</span><br><span class="line">	at java.net.URI$Parser.parseHostname(URI.java:<span class="number">3387</span>)</span><br><span class="line">	at java.net.URI$Parser.parseServer(URI.java:<span class="number">3236</span>)</span><br><span class="line">	at java.net.URI$Parser.parseAuthority(URI.java:<span class="number">3155</span>)</span><br><span class="line">	at java.net.URI$Parser.parseHierarchical(URI.java:<span class="number">3097</span>)</span><br><span class="line">	at java.net.URI$Parser.parse(URI.java:<span class="number">3053</span>)</span><br><span class="line">	at java.net.URI.&lt;init&gt;(URI.java:<span class="number">673</span>)</span><br><span class="line">	at java.net.URI.&lt;init&gt;(URI.java:<span class="number">774</span>)</span><br><span class="line">	at TestURL.main(TestURL.java:<span class="number">45</span>)</span><br></pre></td></tr></table></figure>
<p><a href="https://www.tanglei.name/resources/conflicts-between-java-net-url-and-java-net-uri-when-dealing-with-hostname-contains-underscore/TestURL.java">点这里下载本文示例代码</a></p>

      
    </div>

    <div>
      
        
<div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="/resources/wechat-tangleithu-codershitou.jpg" alt="tanglei wechat" style="width: 400px; max-width: 100%;">
    <div>欢迎扫码加入互联网大厂内推群 & 技术交流群，一起学习、共同进步</div>
</div>


      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Java/" rel="tag"># Java</a>
          
            <a href="/tags/Bug/" rel="tag"># Bug</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/Apache-benchmarking-usage.html" rel="next" title="性能测试工具 - ab 简单应用">
                <i class="fa fa-chevron-left"></i> 性能测试工具 - ab 简单应用
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/blog/the-way-to-calculate-apr.html" rel="prev" title="信用卡分期年化利率计算方法">
                信用卡分期年化利率计算方法 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/tx.jpg" alt="tanglei">
          <p class="site-author-name" itemprop="name">tanglei</p>
          <p class="site-description motion-element" itemprop="description">码农 @ 阿里云, 毕业于CSU && THU,  曾工作于大疆(DJI), 宜信大数据创新中心, <a href="http://www.tencent.com/zh-cn/index.shtml" target="_blank">腾讯</a> && <a href="http://www.umeng.com/" target="_blank">友盟</a>.  &nbsp; <a href="/about/"> MORE </a></p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">481</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">151</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="/resources/tl3shi-wechat.png" target="_blank" title="Wechat">
                  
                    <i class="fa fa-fw fa-weixin"></i>
                  
                  Wechat
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/tl3shi" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/tangleithu" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#server-端准备"><span class="nav-number">1.</span> <span class="nav-text">server 端准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#client"><span class="nav-number">2.</span> <span class="nav-text">client</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#curl-命令"><span class="nav-number">2.1.</span> <span class="nav-text">curl 命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#python-requests"><span class="nav-number">2.2.</span> <span class="nav-text">python requests</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#java"><span class="nav-number">2.3.</span> <span class="nav-text">java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JDK-java-net-URL-中的-“bug”"><span class="nav-number">2.4.</span> <span class="nav-text">JDK(java.net.URL) 中的 “bug” ?</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#附件"><span class="nav-number">3.</span> <span class="nav-text">附件</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2010 - 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">tanglei</span>
   
  <span class="author" itemprop="copyrightHolder">
      - 渝ICP备16013386号 
  </span>
 
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'hexo-tanglei';
      var disqus_identifier = 'blog/conflicts-between-java-net-url-and-java-net-uri-when-dealing-with-hostname-contains-underscore.html';

      var disqus_title = "JDK(java.net.URL) 中的 一个 \"bug\"";


      function run_disqus_script(disqus_script) {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');

      
        var disqus_config = function () {
            this.page.url = disqus_url;
            this.page.identifier = disqus_identifier;
            this.page.title = disqus_title;
        };
        run_disqus_script('embed.js');
      

    </script>
  







  
  

  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  


</body>
</html>
