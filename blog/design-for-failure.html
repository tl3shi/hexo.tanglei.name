<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css">


  <meta name="keywords" content="转载,总结,">





  <link rel="alternate" href="/atom.xml" title="唐磊的个人博客" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0">






<meta name="description" content="关于作者：程序猿石头(ID: tangleithu)，从十八县贫困农村一路逆袭上清华（点这里查看我的逆袭之路），BAT某厂P7，是前大疆（无人机）技术主管。 本文首发于微信公众号，原文链接，转载请全文保留。后台回复关键字 “1024” 获取程序员大厂面试指南。  背景大家好，我是石头哥。 前不久我看到一篇文章，名字叫做《向死而生：面向失败设计之道、术、技》，当时草草读完，觉得需要细度一番，于是便">
<meta name="keywords" content="转载,总结">
<meta property="og:type" content="article">
<meta property="og:title" content="为什么要面向失败设计？">
<meta property="og:url" content="https://www.tanglei.name/blog/design-for-failure.html">
<meta property="og:site_name" content="唐磊的个人博客">
<meta property="og:description" content="关于作者：程序猿石头(ID: tangleithu)，从十八县贫困农村一路逆袭上清华（点这里查看我的逆袭之路），BAT某厂P7，是前大疆（无人机）技术主管。 本文首发于微信公众号，原文链接，转载请全文保留。后台回复关键字 “1024” 获取程序员大厂面试指南。  背景大家好，我是石头哥。 前不久我看到一篇文章，名字叫做《向死而生：面向失败设计之道、术、技》，当时草草读完，觉得需要细度一番，于是便">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://www.tanglei.name/resources/design-for-failure/1.jpg">
<meta property="og:image" content="d:/github/hexo.tanglei.name/resources/design-for-failure/2.jpg">
<meta property="og:image" content="https://www.tanglei.name/resources/design-for-failure/3.jpg">
<meta property="og:image" content="https://www.tanglei.name/resources/design-for-failure/4.jpg">
<meta property="og:updated_time" content="2023-05-21T02:40:26.191Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="为什么要面向失败设计？">
<meta name="twitter:description" content="关于作者：程序猿石头(ID: tangleithu)，从十八县贫困农村一路逆袭上清华（点这里查看我的逆袭之路），BAT某厂P7，是前大疆（无人机）技术主管。 本文首发于微信公众号，原文链接，转载请全文保留。后台回复关键字 “1024” 获取程序员大厂面试指南。  背景大家好，我是石头哥。 前不久我看到一篇文章，名字叫做《向死而生：面向失败设计之道、术、技》，当时草草读完，觉得需要细度一番，于是便">
<meta name="twitter:image" content="https://www.tanglei.name/resources/design-for-failure/1.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"always"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://www.tanglei.name/blog/design-for-failure.html">





  <title> 为什么要面向失败设计？ | 唐磊的个人博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f0117177475f54027bfcaceb8d668cee";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">唐磊的个人博客</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <h1 class="site-subtitle" itemprop="description">记录我的学习、生活、工作。</h1>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://www.tanglei.name/blog/design-for-failure.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="tanglei">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/tx.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="唐磊的个人博客">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="唐磊的个人博客" src>
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                为什么要面向失败设计？
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2022-04-23T00:00:00+00:00">
                2022-04-23
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/总结/" itemprop="url" rel="index">
                    <span itemprop="name">总结</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/blog/design-for-failure.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="blog/design-for-failure.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>关于作者：程序猿石头(ID: tangleithu)，从十八县贫困农村一路逆袭上<strong>清华</strong>（<a href="https://mp.weixin.qq.com/s/G3i7qWK1MPvJ-BfUxfOycQ" target="_blank" rel="noopener">点这里查看我的逆袭之路</a>），BAT某厂P7，是前大疆（无人机）技术主管。</p>
<p>本文首发于微信公众号，<a href>原文链接</a>，转载请全文保留。后台回复关键字 “1024” 获取程序员大厂面试指南。</p>
</blockquote>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>大家好，我是石头哥。</p>
<p>前不久我看到一篇文章，名字叫做《向死而生：面向失败设计之道、术、技》，当时草草读完，觉得需要细度一番，于是便收藏了。前几天从收藏夹里面翻出来，再仔细看了一遍，觉得很不错，有很多方法也是我目前在软件设计过程中一直遵循的标准。</p>
<p>今天，就分享给大家，希望能给大家带来收获，文章较长，于是给出目录如下：</p>
<ul>
<li>一、序<ul>
<li>1.1 从两个故事说起</li>
<li>1.2 关于我</li>
<li>1.3 关于选题</li>
</ul>
</li>
<li>二、道<ul>
<li>2.1 失败无处不在</li>
<li>2.2 唯一不变的是变化</li>
<li>2.3 对代码的世界保持警惕</li>
<li>2.4 设计原则</li>
</ul>
</li>
<li>三、术<ul>
<li>3.1 组织</li>
<li>3.2 流程</li>
<li>3.3 一些观点</li>
</ul>
</li>
<li>四、技<ul>
<li>4.1 将面向失败当做系统设计的一部分</li>
<li>4.2 分布式锁的六个层次</li>
<li>4.3 热点库存扣减</li>
</ul>
</li>
<li>五、跋</li>
<li>六、引</li>
</ul>
<p>建议点赞、收藏！</p>
<h2 id="一、序"><a href="#一、序" class="headerlink" title="一、序"></a>一、序</h2><h3 id="1-1-从两个故事说起"><a href="#1-1-从两个故事说起" class="headerlink" title="1.1 从两个故事说起"></a>1.1 从两个故事说起</h3><p>2015 年 5 月，杭州市萧山区某地光缆被挖断，某公司支付软件受到影响，用户反复登录却无法使用，一时间#XXX炸了#成为微博热词；2021 年 7 月 ，某视频网站深夜宕机，各系产品所有功能似乎全崩，直至次日凌晨才恢复服务。这两个故事，导致吃瓜群众对企业技术实力产生了质疑和误解，影响颇深……</p>
<h3 id="1-2-关于我"><a href="#1-2-关于我" class="headerlink" title="1.2 关于我"></a>1.2 关于我</h3><p>讲完两个故事，说说我自己，前抖音电商 C 端营销&amp;大促方向 POC，阿里巴巴 2020 年货节&amp;后年货节大促集团技术总执行 PM，广告和电商领域六年后端开发经验，久经大数据量、高并发、巨额资金场景下的技术考验。</p>
<h3 id="1-3-关于选题"><a href="#1-3-关于选题" class="headerlink" title="1.3 关于选题"></a>1.3 关于选题</h3><p>从两个故事可以看出，对于失败场景考虑不充分对于企业声誉的打击有多大。站在程序员个体角度，面向失败设计对于个人的影响也同样巨大，企业的事故责任终究要落到程序员个人头上，而事故也往往会消耗组织对于个人的信任，直接或者间接地影响个人的发展。在字节跳动，事故对个人的影响不算太大，但在其他一些公司，一次事故往往意味着程序员“一年白干”。</p>
<p>不同年限的程序员差异到底在哪里？这个问题，我的理解是，除了架构设计能力、项目管理能力、技术规划能力、技术领导力之外，<strong>面向失败设计能力</strong>也是极其重要的一环。</p>
<p>业务开发的新同学有时候可能会有迷之自信，觉得自己写的代码与老鸟们没有什么不同。实际上，编写正常流程的业务代码大家的差异不会太大，但是针对<strong>异常、边界、不确定性</strong>的处理才真正体现一个程序员的功力。老鸟们往往在长期的训练下已经形成多种肌肉记忆，遇到具体问题就会举一反三脑海里冒出诸多面向失败的设计点，从而写出高可用的业务代码。如何去学习面向失败设计的方法论，并慢慢形成自己独有的肌肉记忆，才是新手向老鸟蜕变的康庄大道。</p>
<p>基于这样的考量，我写了这篇文章，对自己这些年来的一些经验和教训做了一些总结，希望能够抛砖引玉，让更多的老鸟们把自己的经验 share 出来，相互学习共同进步。</p>
<h2 id="二、道"><a href="#二、道" class="headerlink" title="二、道"></a>二、道</h2><p>道的层面，我想讲讲面向失败设计的世界观。</p>
<h3 id="2-1-失败无处不在"><a href="#2-1-失败无处不在" class="headerlink" title="2.1 失败无处不在"></a>2.1 失败无处不在</h3><p>理想中，机器硬件永不老化、系统软件永不过期、流量总在预期范围内、自己写的代码没有 bug、产品经理永不改需求，但现实往往给你饱以老拳，给你社会的毒打：硬件一定会在某个时间点故障、软件总在一个时间节点跟不上时代潮流、流量总在你意想不到的时候突增——即使你在婚礼上、没有程序员不写 bug、产品经理不但天天改需求，甚至还给你提自相矛盾或者存在逻辑漏洞的需求。</p>
<p><img src="/resources\design-for-failure\1.jpg" alt="图片"></p>
<p>无论是在传统软件时代还是在互联网、云时代，系统终究会在某个时间点失败。面向失败设计不是消除失败，而是减少乃至消除失败造成的影响，守着企业和个人的钱袋子。</p>
<h3 id="2-2-唯一不变的是变化"><a href="#2-2-唯一不变的是变化" class="headerlink" title="2.2 唯一不变的是变化"></a>2.2 唯一不变的是变化</h3><p>不但失败无处不在，变化也无处不在。（哈哈，原来阿里常说的这句话给作者带来了深刻的影响，更多阿里相关内容可参考：<a href="https://mp.weixin.qq.com/s?__biz=MzI3OTUzMzcwNw==&amp;mid=2247496779&amp;idx=1&amp;sn=afbdc3fa174e9d20799ea10e79f70f71&amp;chksm=eb44f5afdc337cb9e7774fb772283a0aa603cb87f9c6b38b11cb31e005ed821054588492ad04&amp;token=668978929&amp;lang=zh_CN#rd" target="_blank" rel="noopener">阿里9年之路</a>）</p>
<h4 id="2-2-1-不要写死——你的-PM-为改需求而生"><a href="#2-2-1-不要写死——你的-PM-为改需求而生" class="headerlink" title="2.2.1 不要写死——你的 PM 为改需求而生"></a>2.2.1 不要写死——你的 PM 为改需求而生</h4><p>“不要写死|你的 PM 为改需求而生”，这句话是我对口的一个产品经理的飞书个性签名，它深得我心。永远对代码写死保持不安，根据墨菲定律，你越是认为不会改变的字段或功能，就越会发生改变。所以，多配置、少写死，让你在产品改需求时快速响应从而令别人刮目相看，也能让你在发生故障时有更多的手段做快速恢复。</p>
<h4 id="2-2-2-隔离可变性——程序员应软件变化而生"><a href="#2-2-2-隔离可变性——程序员应软件变化而生" class="headerlink" title="2.2.2 隔离可变性——程序员应软件变化而生"></a>2.2.2 隔离可变性——程序员应软件变化而生</h4><p>如果系统软件永不变化，我们还需要设计模式么？还需要面向对象么？面向过程一把梭不是又快又好么？但是，永不变化的系统软件，要程序员何用？抖音已经如此强大，什么都不改也能给字节挣很多钱，那抖音的程序员都可以下岗了么？好像并非如此。</p>
<p>设计模式，是前辈们总结的应对变化的利器。23 种设计模式，一言以蔽之，曰：隔离可变性。无论是创建型模式，还是结构性模型，又或者是行为型模式，设计的目的都是为了把变化关进设计模式的笼子里。</p>
<h4 id="2-2-3-定期回归——功能在演化中变质"><a href="#2-2-3-定期回归——功能在演化中变质" class="headerlink" title="2.2.3 定期回归——功能在演化中变质"></a>2.2.3 定期回归——功能在演化中变质</h4><p>定期回归，也是应对失败的重要原则。互联网的迭代实在是太快了，传统软件往往以年月为维度迭代，而互联网往往以周乃至日迭代。每一天，系统的功能都可能在演化中变质，快速的迭代不但让业务代码迅速腐化变成屎山，也让内部逻辑日益臃肿，乃至相互冲突。终有一天，原本运行良好无 bug 的代码，会变成事故的导火索。</p>
<h3 id="2-3-对代码的世界保持警惕"><a href="#2-3-对代码的世界保持警惕" class="headerlink" title="2.3 对代码的世界保持警惕"></a>2.3 对代码的世界保持警惕</h3><p>对代码的世界保持警惕吧，不然总有一天你会经历血泪教训。</p>
<h4 id="2-3-1-不要相信合作方的“鬼话”"><a href="#2-3-1-不要相信合作方的“鬼话”" class="headerlink" title="2.3.1 不要相信合作方的“鬼话”"></a>2.3.1 不要相信合作方的“鬼话”</h4><p>对合作方给你的所有接口、方案保持怀疑，也不要相信合作方任何一个未经你亲身验证的论断。实践才是检验真理的唯一标准，对世界始终保持怀疑是工程师的核心素质。不要在出现故障之后跟合作方相互甩锅时才追悔莫及，前期多做些验证，保护了你也保护了他，更是保护了你们之间的塑料友情。</p>
<h4 id="2-3-2-不要相信代码注释"><a href="#2-3-2-不要相信代码注释" class="headerlink" title="2.3.2 不要相信代码注释"></a>2.3.2 不要相信代码注释</h4><p>一行错误的代码注释，把我从阿里带到了字节，亲身经历的血泪教训。错误的代码注释不如没有注释，不要再用错误的注释给后来人埋坑了，救救孩子吧。</p>
<h4 id="2-3-3-不要相信函数输入"><a href="#2-3-3-不要相信函数输入" class="headerlink" title="2.3.3 不要相信函数输入"></a>2.3.3 不要相信函数输入</h4><p>NPE（NullPointerException 空指针异常）也许是程序员职业生涯中遇到过的最多的错误，这一点颇令人困惑，因为程序员从刷 LeetCode 第一道题开始，就知道需要对函数参数做检查。</p>
<p>之所以出现这样的结果，是因为线上生产环境所能遭遇的场景远比一道代码题复杂，这其实也是工业界与学术界的区别，学术界的问题是确定的，工业界的问题是不确定的。即使上游传递参数的是一个你认为极为可靠的系统，即使你遍览程序上下文确定不会出现空参数，也最好去做一些防御性的设计，因为可靠的系统也会给你返回不合规范的参数，当前不存在空参数的代码在未来的某一天也会被改得面目全非。</p>
<h4 id="2-3-4-不要相信基础设施"><a href="#2-3-4-不要相信基础设施" class="headerlink" title="2.3.4 不要相信基础设施"></a>2.3.4 不要相信基础设施</h4><p>即使是支付宝也会崩溃，即使是可用性 6 个 9 的系统，全年也有 31 秒中断。不要相信基础设施，做好灾备，搞好混沌工程，才能让你每个晚上睡得安稳，避免被报警电话打醒。</p>
<h3 id="2-4-设计原则"><a href="#2-4-设计原则" class="headerlink" title="2.4 设计原则"></a>2.4 设计原则</h3><h4 id="2-4-1-简洁的方案最优雅"><a href="#2-4-1-简洁的方案最优雅" class="headerlink" title="2.4.1 简洁的方案最优雅"></a>2.4.1 简洁的方案最优雅</h4><p>如果你设计的技术方案没有太多的花里胡哨，整体透露着一种大道至简的美感，也许你就离成功很近了。简洁的方案代表着更小的理解成本、更小的维护成本、更好的扩展性。</p>
<p>如果你的方案里面到处都是花里胡哨的炫技，看起来复杂而严谨，那么也许你离让自己头疼也让别人头疼不远了，一顿操作猛如虎，一看月薪两千五。</p>
<p>当然，并不是最简洁的方案就是最合适的方案，举个栗子，核心交易链路的服务必然会比数据展示的服务稳定性要求更高，因而做了较多高可用设计之后方案会更加复杂，因而在满足稳定性的前提下选用尽可能简洁的方案才是推荐的做法。</p>
<h4 id="2-4-2-开闭原则是设计模式的总纲"><a href="#2-4-2-开闭原则是设计模式的总纲" class="headerlink" title="2.4.2 开闭原则是设计模式的总纲"></a>2.4.2 开闭原则是设计模式的总纲</h4><p>开闭原则是设计模式的总纲，大部分设计模式里面都有开闭原则的影子，软件实体应当对扩展开放，对修改关闭，可以通过“抽象约束、封装变化”来实现开闭原则。开闭原则可以使软件实体拥有一定的适应性和灵活性的同时具备稳定性和延续性。</p>
<p>基于开闭原则，很多常见的设计问题都有了答案：</p>
<p><strong>（1）大量 if-else 的屎山代码问题。</strong> 大量的 if-else 肯定是不符合开闭原则的，每一个 if-else 的代码支路都是对原有代码结构的破坏，这里就可以应用工厂+策略设计模式对 if-else 进行剥离，把逻辑的新增和修改限制在工厂模式子类的内部。</p>
<p><strong>（2）冗长的业务工作流处理问题。</strong> 业务流程代码往往非常冗长，封装得不好的话阅读和维护代码都非常困难，可以考虑用命令+职责链设计模式对工作流做封装。封装的好处在于，整体的工作流读起来将非常清晰，主流程代码往往能从数百行精简到十行以内，并且，对流程的修改仅仅是简单的断链或者增加链节点的操作，从而把修改的影响减到最低。</p>
<p><strong>（3）历史字段类型修改问题。</strong> 互联网开发过程中经常需要修改历史字段的类型，根据开闭原则，我们不该去修改原有字段的类型，而应该新增一个字段，这样才能保证对上下游链路的影响最小。</p>
<p><strong>（4）对象属性中途篡改问题。</strong> 举个实际的业务场景，在某些业务请求中，抖音极速版需要做与抖音相同的处理，把抖音极速版的 APPID 改成抖音的 APPID 是最简单的方法，但是这种做法是不符合开闭原则的，对对象属性中途的篡改，会改变对象在程序中的语义，总有一天它会有不符合预期的表现，很多事故因此而起。正确的做法是，在上下文中传递一个新的字段，下游的每一步处理都可以选择正确的字段做正确的处理，而不会被中途篡改的字段蒙蔽。</p>
<h4 id="2-4-3-懒惰是程序员最大的美德"><a href="#2-4-3-懒惰是程序员最大的美德" class="headerlink" title="2.4.3 懒惰是程序员最大的美德"></a>2.4.3 懒惰是程序员最大的美德</h4><p>懒惰是程序员最大的美德，好的程序员往往是默默无闻的，越是在团队里面滋哇乱叫到处救火刷存在感的程序员越可能是团队的慢性毒药。</p>
<p>为了让自己懒惰，安安稳稳躺平就把业务做好，程序员必须掌握<strong>平台化、工具化、自动化</strong>三板斧。平台化，把程序员从无穷尽的重复劳动中解救出来；工具化，把程序员从水深火热的人肉运维和 oncall 中解救出来；自动化，让程序如流水线般顺滑，从而提升程序员的人效。能将这三板斧挥舞到什么层次，也体现了程序员能力到达了什么层次。有了平台化、工具化、自动化，就可以做标准化、规模化，助力公司和业务持续往上走。</p>
<h2 id="三、术"><a href="#三、术" class="headerlink" title="三、术"></a>三、术</h2><p>术的层面，我想讲讲在组织和流程角度如何面向失败设计。</p>
<h3 id="3-1-组织"><a href="#3-1-组织" class="headerlink" title="3.1 组织"></a>3.1 组织</h3><h4 id="3-1-1-面向失败设计的工种"><a href="#3-1-1-面向失败设计的工种" class="headerlink" title="3.1.1 面向失败设计的工种"></a>3.1.1 面向失败设计的工种</h4><p>测试工程师、测试开发工程师、风控&amp;安全合规工程师都是开发工程师最可靠的合作伙伴，也是企业为了面向失败设计而设置的工种。</p>
<p><strong>测试工程师</strong>是软件质量的把关者，他们是线上质量的卫士，对开发工程师代码的质量和性能负责。<strong>测试开发工程师</strong>是一个技术型的软件测试工种，除了做常规的测试工作之外，还会写一些测试工具和自动化脚本，用自动化的手段来提高测试的质量和效率。风控和反作弊工程师对业务的生态负责，监测业务的异常问题，提高业务风控的效果。<strong>安全合规工程师</strong>，则是对信息安全负责，能够对于项目提供合规咨询、信息安全风险评估。</p>
<h4 id="3-1-2-面向失败设计的组织形式"><a href="#3-1-2-面向失败设计的组织形式" class="headerlink" title="3.1.2 面向失败设计的组织形式"></a>3.1.2 面向失败设计的组织形式</h4><p><strong>安全生产小组</strong>是一种面向失败设计的组织形式。安全生产小组往往是横向的技术团队，对多个业务团队提供规范制定和推行、生产过程管控、事故复盘组织等技术支持，为线上质量负责，通常还会在每个业务团队设置系统稳定性负责人，作为接口人来有效推行他们制定的制度。</p>
<p><strong>结对编程</strong>，也是一种面向失败设计的组织形式。严格意义的结对编程，要求两个程序员在一个计算机上共同工作。一个人输入代码，而另一个人审查他输入的每一行代码。结对编程可以让程序员写出更短的程序，更好的设计，以及更少的缺陷，同时，结对编程也可以促进知识的传播，让新人快速进步，也让老人在带新的过程中总结自己的知识和经验，还可以规避在相应开发人员请假或者离职带来的工作交接的问题。</p>
<p>严格意义的结对编程，在互联网行业极为罕见，很少有团队会真正这样实操，也许是因为在管理者看来，两个人干同一件事情大大增加了人力的成本。但是，结对编程的一些思想和理念，也值得我们借鉴，比如我们可以让两个程序员结对做业务 owner，互为 backup，相互 code review，从而在一定程度上获得结对编程的好处。</p>
<h3 id="3-2-流程"><a href="#3-2-流程" class="headerlink" title="3.2 流程"></a>3.2 流程</h3><p>假设不做面向失败设计，那么软件开发流程也许可以简化为编码+发布两步。但是成熟企业的开发流程大致如下：</p>
<p><img src="D:\github\hexo.tanglei.name\resources\design-for-failure\2.jpg" alt="图片"></p>
<p><strong>需求提出阶段</strong>，需要先期做一些合规评估、反作弊评估、安全评估，在前期就把一些潜在的安全合规风险排除。</p>
<p><strong>编码阶段</strong>，在设计技术方案时需要考虑止血/降级/回滚措施，并组织技术评审和安全技术评审，针对技术方案中的安全风险做一些评估。除此之外，最好做一些单元测试，可以大大提高代码的质量。</p>
<p><strong>测试阶段</strong>，需要开发人员先做自测，再让测试工程师参与功能测试、安全工程师做安全检查，针对代码改动可能造成的额外影响，做好做一次更大范围的回归测试，以排除一些预期外的影响。</p>
<p><strong>发布阶段</strong>，需要采用灰度发布的机制，先发布小部分机器，或者仅针对部分地区用户灰度，在灰度发布之后做灰度测试验证功能正常，在继续分批发布、全量发布。</p>
<p><strong>验证阶段</strong>，可以让测试同学在发布完成之后做一次线上回归，保证功能在线上环境稳定可用。对于大型活动，往往还需要组织内部用户线上预演或众测。针对非预期内流量可能把系统打挂的风险，可以做单链路压测和全链路压测。在大型活动开始前，如果条件允许，或者在小范围做一次线上试玩，提前暴露一些风险。</p>
<p><strong>运行阶段</strong>，需要开发人员做好监控报警和离在线数据对账。对于项目的效果，可以用 AB 测试来量化收益。</p>
<p><strong>故障发生时</strong>，第一时间必须做好故障快速恢复，尽可能减少线上损失，之后再考虑定位故障原因。</p>
<p>在项目结束或者故障处理结束之后，需要组织一次有效的<strong>复盘</strong>，并对过程中的问题做一些总结，形成有效的改进方案，并持续跟进改进方案的落地</p>
<h3 id="3-3-一些观点"><a href="#3-3-一些观点" class="headerlink" title="3.3 一些观点"></a>3.3 一些观点</h3><h4 id="3-3-1-测试同学的重要性，怎么吹都不为过"><a href="#3-3-1-测试同学的重要性，怎么吹都不为过" class="headerlink" title="3.3.1 测试同学的重要性，怎么吹都不为过"></a>3.3.1 测试同学的重要性，怎么吹都不为过</h4><p>测试工程师是线上质量最重要的卫士，他们的重要性，怎么吹都不为过。一个优秀的测试同学，可以做到以下事情：</p>
<ul>
<li>非黑盒测试，具备读懂开发代码的能力，根据代码针对性地设计测试用例</li>
<li>设计完备的测试用例，覆盖所有测试场景</li>
<li>编写数据对账脚本，能够做离线数据对账和实时数据对账</li>
<li>编写自动化测试工具</li>
<li>编写数据一致性监控脚本、资损防控工具</li>
</ul>
<h4 id="3-3-2-单元测试最省时间"><a href="#3-3-2-单元测试最省时间" class="headerlink" title="3.3.2 单元测试最省时间"></a>3.3.2 单元测试最省时间</h4><p>编写单元测试用例，看似费时间，实则是最省时间的做法。单元测试保证了代码的行为与我们期望一致，从而省下了大量的发布、自测、联调、修改代码的返工时间，另外，可以做单元测试的代码往往职责更加清晰、分层分块更加合理、稳定性更好。</p>
<h4 id="3-3-3-复盘是对齐做事高标准的一个必要方式"><a href="#3-3-3-复盘是对齐做事高标准的一个必要方式" class="headerlink" title="3.3.3 复盘是对齐做事高标准的一个必要方式"></a>3.3.3 复盘是对齐做事高标准的一个必要方式</h4><p>复盘是不断优化组织，对齐做事高标准的一个必要方式。通过 PDCA（Plan-Do-Check-Action，戴明环）这样的一个循环，工作在不断的改善后，最终形成知识沉淀，作用于下一次计划执行，团队于是变得越来越有执行力，个人则成为 Better Me。</p>
<h4 id="3-3-4-研发红线是程序员的保护伞"><a href="#3-3-4-研发红线是程序员的保护伞" class="headerlink" title="3.3.4 研发红线是程序员的保护伞"></a>3.3.4 研发红线是程序员的保护伞</h4><p>研发红线是企业面向失败设计行之有效的暴力机器，它由无数零件（规范和条目）组成、冰冷、机械、运行起来无法阻挡，不以个人意志为转移。研发红线强制要求程序员遵守企业的流程和规范，警告程序员不犯低级错误，看似冰冷无情，实则是程序员的保护伞。</p>
<h2 id="四、技"><a href="#四、技" class="headerlink" title="四、技"></a>四、技</h2><p>在技的层面，我想谈谈面向失败设计的具体技术细节。但是技术细节实在太多，限于篇幅，此处只列举一些经典技术问题的解法。</p>
<h3 id="4-1-将面向失败当做系统设计的一部分"><a href="#4-1-将面向失败当做系统设计的一部分" class="headerlink" title="4.1 将面向失败当做系统设计的一部分"></a>4.1 将面向失败当做系统设计的一部分</h3><ul>
<li>针对非预期流量，可以做系统限流、系统过载保护、自适应扩缩容；</li>
<li>针对依赖服务超时或错误，需要对依赖系统设置超时时间，并对所有依赖做强弱依赖梳理，关键时刻降级非核心依赖；</li>
<li>针对预期外的情况，可以提前准备好紧急预案，并做好预案演练；</li>
<li>针对瞬时高流量，需要敏锐地判断系统的极限，做好流量打散，并避免 DB 和缓存热 key；</li>
<li>针对可能出现的机房问题，做好同城双（多）活和异地多活；</li>
<li>针对人为失误，可以使用平台化、工具化、自动化的方法减少人肉操作；</li>
<li>避免出现单点问题，做冗余设计来降低局部失败对系统的影响；</li>
<li>失败重试时需谨慎，避免踩踏雪崩；</li>
<li>故障只能减少，不能消除，做好监控报警、故障演练、攻防演练，锤炼风险应急能力；</li>
</ul>
<h3 id="4-2-分布式锁的六个层次"><a href="#4-2-分布式锁的六个层次" class="headerlink" title="4.2 分布式锁的六个层次"></a>4.2 分布式锁的六个层次</h3><blockquote>
<p>你只看到了第二层，你把我想成了第一层。实际上，我在第五层。</p>
<p>——芜湖大司马</p>
</blockquote>
<p>Redis 实现分布式锁有六个层次，看看大家平常用的分布式锁处在第几个层次。</p>
<p>（这个其实也是常见的面试题之一，更多可参考 <a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzI3OTUzMzcwNw==&amp;action=getalbum&amp;album_id=1551696963291693061&amp;scene=173&amp;from_msgid=&amp;from_itemidx=&amp;count=3&amp;nolastread=1#wechat_redirect" target="_blank" rel="noopener">程序员面试</a>，对阿里感兴趣的同学千万别错过 —— <a href="https://mp.weixin.qq.com/s?__biz=MzI3OTUzMzcwNw==&amp;mid=2247495225&amp;idx=1&amp;sn=c99a906c2e2dc591d7ecaac798330fb3&amp;chksm=eb44efdddc3366cb1ed31d3468097ceef0d41f00dcc8ed8f6eb0804d0b895576a4fcc5718249&amp;token=668978929&amp;lang=zh_CN#rd" target="_blank" rel="noopener">面试阿里，看这一篇就够了！</a>）</p>
<p><strong>分布式锁设计原则：</strong></p>
<ul>
<li>互斥性。在任意时刻，只有一个客户端持有锁。</li>
<li>不死锁。分布式锁本质上是一个基于租约（Lease）的租借锁，如果客户端获得锁后自身出现异常，锁能够在一段时间后自动释放，资源不会被锁死。</li>
<li>一致性。硬件故障或网络异常等外部问题，以及慢查询、自身缺陷等内部因素都可能导致 Redis 发生高可用切换，replica 提升为新的 master。此时，如果业务对互斥性的要求非常高，锁需要在切换到新的 master 后保持原状态。</li>
</ul>
<p><strong>层次一：</strong></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">redis.SetNX(ctx, key, <span class="string">"1"</span>)</span><br><span class="line"><span class="keyword">defer</span> redis.del(ctx, key)</span><br></pre></td></tr></table></figure>
<p>使用 SetNx 命令，可以解决互斥性的问题，但不能做到不死锁。</p>
<p><strong>层次二：</strong></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">redis.SetNX(ctx, key, <span class="string">"1"</span>, expiration)</span><br><span class="line"><span class="keyword">defer</span> redis.del(ctx, key)</span><br></pre></td></tr></table></figure>
<p>使用 lua 脚本保证 SetNX 与 Expire 的原子性，做到了不死锁，但是做不到一致性。</p>
<p><strong>层次三：</strong></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">redis.SetNX(ctx, key, randomValue, expiration)</span><br><span class="line"><span class="keyword">defer</span> redis.del(ctx, key, randomValue)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以下为del的lua脚本</span></span><br><span class="line"><span class="keyword">if</span> redis.call(<span class="string">"get"</span>,KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>] then</span><br><span class="line">   <span class="keyword">return</span> redis.call(<span class="string">"del"</span>,KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>分布式锁的值设定一个随机数，删除时只删除当前线程/协程抢到的锁，避免在程序运行过慢锁过期时删除别的线程/协程的锁，能做到一定程度的一致性。</p>
<p><strong>层次四：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">func <span class="title">myFunc</span><span class="params">()</span> <span class="params">(errCode *constant.ErrorCode)</span> </span>&#123;</span><br><span class="line">    errCode := DistributedLock(ctx, key, randomValue, LockTime)</span><br><span class="line">    <span class="function">defer <span class="title">DelDistributedLock</span><span class="params">(ctx, key, randomValue)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">if</span> errCode !</span>= nil &#123;</span><br><span class="line">       <span class="keyword">return</span> errCode</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// doSomeThing</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">func <span class="title">DistributedLock</span><span class="params">(ctx context.Context, key, value string, expiration time.Duration)</span> <span class="params">(errCode *constant.ErrorCode)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   ok, err := redis.SetNX(ctx, key, value, expiration)</span><br><span class="line">   <span class="keyword">if</span> err == nil &#123;</span><br><span class="line">      <span class="keyword">if</span> !ok &#123;</span><br><span class="line">         <span class="keyword">return</span> constant.ERR_MISSION_GOT_LOCK</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> nil</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 应对超时且成功场景，先get一下看看情况</span></span><br><span class="line">   time.Sleep(DistributedRetryTime)</span><br><span class="line">   v, err := redis.Get(ctx, key)</span><br><span class="line">   <span class="keyword">if</span> err != nil &#123;</span><br><span class="line">      <span class="keyword">return</span> constant.ERR_CACHE</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> v == value &#123;</span><br><span class="line">      <span class="comment">// 说明超时且成功</span></span><br><span class="line">      <span class="keyword">return</span> nil</span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> v != <span class="string">""</span> &#123;</span><br><span class="line">      <span class="comment">// 说明被别人抢了</span></span><br><span class="line">      <span class="keyword">return</span> constant.ERR_MISSION_GOT_LOCK</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 说明锁还没被别人抢，那就再抢一次</span></span><br><span class="line">   ok, err = redis.SetNX(ctx, key, value, expiration)</span><br><span class="line">   <span class="keyword">if</span> err != nil &#123;</span><br><span class="line">      <span class="keyword">return</span> constant.ERR_CACHE</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> !ok &#123;</span><br><span class="line">      <span class="keyword">return</span> constant.ERR_MISSION_GOT_LOCK</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以下为del的lua脚本</span></span><br><span class="line"><span class="keyword">if</span> redis.call(<span class="string">"get"</span>,KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>] then</span><br><span class="line">   <span class="keyword">return</span> redis.call(<span class="string">"del"</span>,KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果你的Redis版本已经支持CAD命令，那么以上lua脚本可以改为以下代码</span></span><br><span class="line"><span class="function">func <span class="title">DelDistributedLock</span><span class="params">(ctx context.Context, key, value string)</span> <span class="params">(errCode *constant.ErrorCode)</span> </span>&#123;</span><br><span class="line">   v, err := redis.Cad(ctx, key, value)</span><br><span class="line">   <span class="keyword">if</span> err != nil &#123;</span><br><span class="line">      <span class="keyword">return</span> constant.ERR_CACHE</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解决超时且成功的问题，写入超时且成功是偶现的、灾难性的经典问题。</p>
<p>还存在的问题是：</p>
<ul>
<li>单点问题，单 master 有问题，如果有主从，那主从复制过程有问题时，也存在问题</li>
<li>锁过期然后没完成流程怎么办</li>
</ul>
<p><strong>层次五：</strong></p>
<p>启动定时器，在锁过期却没完成流程时续租，只能续租当前线程/协程抢占的锁。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 以下为续租的lua脚本，实现CAS（compare and set）</span></span><br><span class="line"><span class="keyword">if</span> redis.call(<span class="string">"get"</span>,KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>] then</span><br><span class="line">    <span class="keyword">return</span> redis.call(<span class="string">"expire"</span>,KEYS[<span class="number">1</span>], ARGV[<span class="number">2</span>])</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果你的Redis版本已经支持CAS命令，那么以上lua脚本可以改为以下代码</span></span><br><span class="line">redis.Cas(ctx, key, value, value)</span><br></pre></td></tr></table></figure>
<p>能保障锁过期的一致性，但是解决不了单点问题。</p>
<p>同时，可以发散思考一下，如果续租的方法失败怎么办？我们如何解决“为了保证高可用而使用的高可用方法的高可用问题”这种套娃问题？开源类库 Redisson 使用了看门狗的方式一定程度上解决了锁续租的问题，但是这里，个人建议不要做锁续租，更简洁优雅的方式是<strong>延长过期时间</strong>，由于我们分布式锁锁住代码块的最大执行时长是可控的（依赖于 RPC、DB、中间件等调用都设定超时时间），因而我们可以把超时时间设得大于最大执行时长即可简洁优雅地保障锁过期的一致性。</p>
<p><strong>层次六：</strong></p>
<p>Redis 的主从同步（replication）是异步进行的，如果向 master 发送请求修改了数据后 master 突然出现异常，发生高可用切换，缓冲区的数据可能无法同步到新的 master（原 replica）上，导致数据不一致。如果丢失的数据跟分布式锁有关，则会导致锁的机制出现问题，从而引起业务异常。针对这个问题介绍两种解法：</p>
<p><strong>（1）使用红锁（RedLock）</strong>。红锁是 Redis 作者提出的一致性解决方案。红锁的本质是一个概率问题：如果一个主从架构的 Redis 在高可用切换期间丢失锁的概率是 k%，那么相互独立的 N 个 Redis 同时丢失锁的概率是多少？如果用红锁来实现分布式锁，那么丢锁的概率是(k%)^N。鉴于 Redis 极高的稳定性，此时的概率已经完全能满足产品的需求。</p>
<p>红锁的问题在于：</p>
<ul>
<li>加锁和解锁的延迟较大。</li>
<li>难以在集群版或者标准版（主从架构）的 Redis 实例中实现。</li>
<li>占用的资源过多，为了实现红锁，需要创建多个互不相关的云 Redis 实例或者自建 Redis。</li>
</ul>
<p><strong>（2）使用 WAIT 命令</strong>。Redis 的 WAIT 命令会阻塞当前客户端，直到这条命令之前的所有写入命令都成功从 master 同步到指定数量的 replica，命令中可以设置单位为毫秒的等待超时时间。客户端在加锁后会等待数据成功同步到 replica 才继续进行其它操作。执行 WAIT 命令后如果返回结果是 1 则表示同步成功，无需担心数据不一致。相比红锁，这种实现方法极大地降低了成本。</p>
<h3 id="4-3-热点库存扣减"><a href="#4-3-热点库存扣减" class="headerlink" title="4.3 热点库存扣减"></a>4.3 热点库存扣减</h3><p>秒杀是非常常见的面试题，很多面试官上来就让面试者设计一个秒杀系统，面试者当然也是“身经百战”，很快可以给出熟背的“标准答案”。</p>
<p>但是，秒杀还是相对简单的热点库存扣减问题，因为扣减的库存量不大。更加典型的热点库存扣减问题是春节红包雨，同一个资金池数亿人抢红包。对于春节红包雨介绍两种方案：</p>
<p><strong>方案一：</strong></p>
<p><img src="/resources\design-for-failure\3.jpg" alt="图片"></p>
<p>存在问题：</p>
<ul>
<li>不同分桶之间，库存消耗不均，可能导致部分用户无法扣减库存，但其他用户可扣减库存，从而引发用户投诉。</li>
</ul>
<p><strong>方案二：</strong></p>
<p><img src="/resources\design-for-failure\4.jpg" alt="图片"></p>
<p>小量多次地分派库存，从而缓解分桶库存消耗不均问题。</p>
<p>2021 年抖音春节红包，将用户进入的时间打散，减少瞬时请求峰值，也是一个很好的技术思路。</p>
<p><strong>如何体现面向失败设计：</strong></p>
<p>（1）为何用定时任务调度主动分配库存，而不是在分桶库存不足时被动拉库存？</p>
<p>答：因为主动分配库存 QPS 比被动拉库存低几个量级。</p>
<p>（2）如何应对超大流量？</p>
<p>答：流量不触达 DB、分桶、打散。</p>
<p>（3）Redis 库存总池为何不用某个 master 机器维护，而用定时任务调度随机挑选机器？</p>
<p>答：防单点。</p>
<h2 id="五、跋"><a href="#五、跋" class="headerlink" title="五、跋"></a>五、跋</h2><p>编程之美，蔚为大观。好的代码，往往结构清晰，表意明确，设计精巧，无论是读代码还是写代码都可以给程序员一种直击心灵的美感，甚至让读者爱不释手，让作者引以为傲，引之为自己的代表作。但是，为了留住这种美，我们还需要去做面向失败的设计，充分考虑失败场景，才能减少失败的概率，向死而得生。</p>
<p>本文对面向失败设计做了一些浅显的思考，欢迎探讨、补充和指正。</p>
<h2 id="六、引"><a href="#六、引" class="headerlink" title="六、引"></a>六、引</h2><ul>
<li>面向失败的设计－概述 <a href="https://developer.aliyun.com/article/726333" target="_blank" rel="noopener">https://developer.aliyun.com/article/726333</a></li>
<li>高性能分布式锁 <a href="https://help.aliyun.com/document_detail/146758.html" target="_blank" rel="noopener">https://help.aliyun.com/document_detail/146758.html</a></li>
<li>原文链接：<a href="https://mp.weixin.qq.com/s/a-RA9hP400qUjcdsXxjSbg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/a-RA9hP400qUjcdsXxjSbg</a></li>
</ul>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>阿里巴巴最近招聘实习生，感兴趣在公众号后台回复“阿里内推”得到内推二维码（社招也可以）。面试前看看如下文章兴趣有点帮助：</p>
<ul>
<li><a href="https://mp.weixin.qq.com/s/C3Smy6ldOhYJU14EztGhkQ" target="_blank" rel="noopener">秋招都结束了，才得知没 HC 了？</a></li>
<li><a href="https://mp.weixin.qq.com/s/OGJhxM7FdeoIkAL2-uUI_Q" target="_blank" rel="noopener">Google 工程师面试指南.pdf-免费下载</a></li>
<li><a href="https://mp.weixin.qq.com/s/iRcyW1dEeCxleTfOTyr2Lw" target="_blank" rel="noopener">清华计算机系王牌课程——《数据结构》课件及源码包下载</a></li>
<li><a href="https://mp.weixin.qq.com/s/7T9R9kFXke986vSoPNzC8g" target="_blank" rel="noopener">BAT大佬写的 1300 页 Leetcode刷题笔记，必须收藏！</a></li>
<li><a href="https://mp.weixin.qq.com/s/DIVTVtChtd287ezWfriBYA" target="_blank" rel="noopener">码农必备 计算机基础知识总结.pdf 和 操作系统总结.pdf</a></li>
<li><a href="https://mp.weixin.qq.com/s/rqTnQH_TTmgmbPm3qV-62Q" target="_blank" rel="noopener">突击大厂网络面试题，「图解网络.pdf」白嫖！</a></li>
</ul>
<p>微信修改了推送机制（改推荐了，也就是你看到的内容不由你主导了），还请记得星标、在看、点赞、留言多互动，这样才能让我的文章及时送达到你手中，ღ 笔芯。</p>
<blockquote>
<p>关于作者：程序猿石头(ID: tangleithu)，从十八县贫困农村一路逆袭上清华（<a href="https://mp.weixin.qq.com/s/G3i7qWK1MPvJ-BfUxfOycQ" target="_blank" rel="noopener">点击这里查看我的逆袭之路</a>），目前在BAT某厂打工，是前大疆（无人机）技术主管。</p>
<p>欢迎扫码加入互联网大厂内推群 &amp; 技术交流群，一起学习、共同进步。后台回复关键字 “<strong>0</strong>” 送阿里技术大礼包。</p>
</blockquote>

      
    </div>

    <div>
      
        
<div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="/resources/wechat-tangleithu-codershitou.jpg" alt="tanglei wechat" style="width: 400px; max-width: 100%;">
    <div>欢迎扫码加入互联网大厂内推群 & 技术交流群，一起学习、共同进步</div>
</div>


      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/转载/" rel="tag"># 转载</a>
          
            <a href="/tags/总结/" rel="tag"># 总结</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/three-year-from-outsource-to-alibaba.html" rel="next" title="花了2年终于从阿里外包转正">
                <i class="fa fa-chevron-left"></i> 花了2年终于从阿里外包转正
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/blog/a-friend-of-me-was-fired.html" rel="prev" title="没想到裁员离我这么近">
                没想到裁员离我这么近 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/tx.jpg" alt="tanglei">
          <p class="site-author-name" itemprop="name">tanglei</p>
          <p class="site-description motion-element" itemprop="description">码农 @ 阿里云, 毕业于CSU && THU,  曾工作于大疆(DJI), 宜信大数据创新中心, <a href="http://www.tencent.com/zh-cn/index.shtml" target="_blank">腾讯</a> && <a href="http://www.umeng.com/" target="_blank">友盟</a>.  &nbsp; <a href="/about/"> MORE </a></p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">518</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">153</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="/resources/tl3shi-wechat.png" target="_blank" title="Wechat">
                  
                    <i class="fa fa-fw fa-weixin"></i>
                  
                  Wechat
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/tl3shi" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/tangleithu" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#背景"><span class="nav-number">1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#一、序"><span class="nav-number">2.</span> <span class="nav-text">一、序</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-从两个故事说起"><span class="nav-number">2.1.</span> <span class="nav-text">1.1 从两个故事说起</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-关于我"><span class="nav-number">2.2.</span> <span class="nav-text">1.2 关于我</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-关于选题"><span class="nav-number">2.3.</span> <span class="nav-text">1.3 关于选题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、道"><span class="nav-number">3.</span> <span class="nav-text">二、道</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-失败无处不在"><span class="nav-number">3.1.</span> <span class="nav-text">2.1 失败无处不在</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-唯一不变的是变化"><span class="nav-number">3.2.</span> <span class="nav-text">2.2 唯一不变的是变化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-1-不要写死——你的-PM-为改需求而生"><span class="nav-number">3.2.1.</span> <span class="nav-text">2.2.1 不要写死——你的 PM 为改需求而生</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-2-隔离可变性——程序员应软件变化而生"><span class="nav-number">3.2.2.</span> <span class="nav-text">2.2.2 隔离可变性——程序员应软件变化而生</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-3-定期回归——功能在演化中变质"><span class="nav-number">3.2.3.</span> <span class="nav-text">2.2.3 定期回归——功能在演化中变质</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-对代码的世界保持警惕"><span class="nav-number">3.3.</span> <span class="nav-text">2.3 对代码的世界保持警惕</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-1-不要相信合作方的“鬼话”"><span class="nav-number">3.3.1.</span> <span class="nav-text">2.3.1 不要相信合作方的“鬼话”</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-2-不要相信代码注释"><span class="nav-number">3.3.2.</span> <span class="nav-text">2.3.2 不要相信代码注释</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-3-不要相信函数输入"><span class="nav-number">3.3.3.</span> <span class="nav-text">2.3.3 不要相信函数输入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-4-不要相信基础设施"><span class="nav-number">3.3.4.</span> <span class="nav-text">2.3.4 不要相信基础设施</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-设计原则"><span class="nav-number">3.4.</span> <span class="nav-text">2.4 设计原则</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-1-简洁的方案最优雅"><span class="nav-number">3.4.1.</span> <span class="nav-text">2.4.1 简洁的方案最优雅</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-2-开闭原则是设计模式的总纲"><span class="nav-number">3.4.2.</span> <span class="nav-text">2.4.2 开闭原则是设计模式的总纲</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-3-懒惰是程序员最大的美德"><span class="nav-number">3.4.3.</span> <span class="nav-text">2.4.3 懒惰是程序员最大的美德</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、术"><span class="nav-number">4.</span> <span class="nav-text">三、术</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-组织"><span class="nav-number">4.1.</span> <span class="nav-text">3.1 组织</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-1-面向失败设计的工种"><span class="nav-number">4.1.1.</span> <span class="nav-text">3.1.1 面向失败设计的工种</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-2-面向失败设计的组织形式"><span class="nav-number">4.1.2.</span> <span class="nav-text">3.1.2 面向失败设计的组织形式</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-流程"><span class="nav-number">4.2.</span> <span class="nav-text">3.2 流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-一些观点"><span class="nav-number">4.3.</span> <span class="nav-text">3.3 一些观点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-1-测试同学的重要性，怎么吹都不为过"><span class="nav-number">4.3.1.</span> <span class="nav-text">3.3.1 测试同学的重要性，怎么吹都不为过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-2-单元测试最省时间"><span class="nav-number">4.3.2.</span> <span class="nav-text">3.3.2 单元测试最省时间</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-3-复盘是对齐做事高标准的一个必要方式"><span class="nav-number">4.3.3.</span> <span class="nav-text">3.3.3 复盘是对齐做事高标准的一个必要方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-4-研发红线是程序员的保护伞"><span class="nav-number">4.3.4.</span> <span class="nav-text">3.3.4 研发红线是程序员的保护伞</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四、技"><span class="nav-number">5.</span> <span class="nav-text">四、技</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-将面向失败当做系统设计的一部分"><span class="nav-number">5.1.</span> <span class="nav-text">4.1 将面向失败当做系统设计的一部分</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-分布式锁的六个层次"><span class="nav-number">5.2.</span> <span class="nav-text">4.2 分布式锁的六个层次</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-热点库存扣减"><span class="nav-number">5.3.</span> <span class="nav-text">4.3 热点库存扣减</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#五、跋"><span class="nav-number">6.</span> <span class="nav-text">五、跋</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#六、引"><span class="nav-number">7.</span> <span class="nav-text">六、引</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#后记"><span class="nav-number">8.</span> <span class="nav-text">后记</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2010 - 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">tanglei</span>
   
  <span class="author" itemprop="copyrightHolder">
      - 渝ICP备16013386号 
  </span>
 
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'hexo-tanglei';
      var disqus_identifier = 'blog/design-for-failure.html';

      var disqus_title = "为什么要面向失败设计？";


      function run_disqus_script(disqus_script) {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');

      
        var disqus_config = function () {
            this.page.url = disqus_url;
            this.page.identifier = disqus_identifier;
            this.page.title = disqus_title;
        };
        run_disqus_script('embed.js');
      

    </script>
  







  
  

  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  


</body>
</html>
