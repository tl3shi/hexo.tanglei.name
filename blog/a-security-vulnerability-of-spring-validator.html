<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css">


  <meta name="keywords" content="经验技巧,Java,网络安全,">





  <link rel="alternate" href="/atom.xml" title="唐磊的个人博客" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0">






<meta name="description" content="之前在某厂的某次项目开发中，项目组同学设计和实现了一个“引以为傲”，额，有点扩张，不过自认为还说得过去的 feature，结果临上线前被啪啪打脸，因为实现过程中因为一行代码（没有标题党，真的是一行代码）带来的安全漏洞让我们丢失了整个服务器控制权（测试环境）。多亏了上线之前有公司安全团队的人会对代码进行扫描，才让这个漏洞被扼杀在摇篮里。 下面我们就一起来看看这个事故，啊，不对，是故事。  背景说明我">
<meta name="keywords" content="经验技巧,Java,网络安全">
<meta property="og:type" content="article">
<meta property="og:title" content="一行代码引来的安全漏洞就让我们丢失了整个服务器的控制权">
<meta property="og:url" content="https://www.tanglei.name/blog/a-security-vulnerability-of-spring-validator.html">
<meta property="og:site_name" content="唐磊的个人博客">
<meta property="og:description" content="之前在某厂的某次项目开发中，项目组同学设计和实现了一个“引以为傲”，额，有点扩张，不过自认为还说得过去的 feature，结果临上线前被啪啪打脸，因为实现过程中因为一行代码（没有标题党，真的是一行代码）带来的安全漏洞让我们丢失了整个服务器控制权（测试环境）。多亏了上线之前有公司安全团队的人会对代码进行扫描，才让这个漏洞被扼杀在摇篮里。 下面我们就一起来看看这个事故，啊，不对，是故事。  背景说明我">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/gif-0.png">
<meta property="og:image" content="https://www.tanglei.name/resources/custom-validator-and-i18n-error-message-in-springboot/i18n-tree.png">
<meta property="og:image" content="https://www.tanglei.name/resources/custom-validator-and-i18n-error-message-in-springboot/validator-bug.png">
<meta property="og:image" content="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/gif-1.gif">
<meta property="og:image" content="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/security-bug-calc-4wx.png">
<meta property="og:image" content="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/security-bug-line-4wx.png">
<meta property="og:image" content="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/security-bug-interpolate-4wx.png">
<meta property="og:image" content="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/security-bug-plus11-4wx.png">
<meta property="og:image" content="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/gif-2.jpeg">
<meta property="og:image" content="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/security-bug-run-process-4wx.png">
<meta property="og:image" content="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/security-bug-run-open-calc-4wx.png">
<meta property="og:image" content="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/spel-bug-demo-0.gif">
<meta property="og:image" content="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/spel-demo-ping.gif">
<meta property="og:image" content="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/gif-3.gif">
<meta property="og:image" content="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/security-bug-el-express-4wx.png">
<meta property="og:image" content="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/security-bug-el-express-run-4wx.png">
<meta property="og:updated_time" content="2022-01-09T16:47:22.991Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="一行代码引来的安全漏洞就让我们丢失了整个服务器的控制权">
<meta name="twitter:description" content="之前在某厂的某次项目开发中，项目组同学设计和实现了一个“引以为傲”，额，有点扩张，不过自认为还说得过去的 feature，结果临上线前被啪啪打脸，因为实现过程中因为一行代码（没有标题党，真的是一行代码）带来的安全漏洞让我们丢失了整个服务器控制权（测试环境）。多亏了上线之前有公司安全团队的人会对代码进行扫描，才让这个漏洞被扼杀在摇篮里。 下面我们就一起来看看这个事故，啊，不对，是故事。  背景说明我">
<meta name="twitter:image" content="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/gif-0.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"always"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://www.tanglei.name/blog/a-security-vulnerability-of-spring-validator.html">





  <title> 一行代码引来的安全漏洞就让我们丢失了整个服务器的控制权 | 唐磊的个人博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f0117177475f54027bfcaceb8d668cee";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">唐磊的个人博客</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <h1 class="site-subtitle" itemprop="description">记录我的学习、生活、工作。</h1>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://www.tanglei.name/blog/a-security-vulnerability-of-spring-validator.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="tanglei">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/tx.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="唐磊的个人博客">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="唐磊的个人博客" src>
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                一行代码引来的安全漏洞就让我们丢失了整个服务器的控制权
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-24T00:00:00+00:00">
                2020-05-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/经验技巧/" itemprop="url" rel="index">
                    <span itemprop="name">经验技巧</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/blog/a-security-vulnerability-of-spring-validator.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="blog/a-security-vulnerability-of-spring-validator.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>之前在某厂的某次项目开发中，项目组同学设计和实现了一个“引以为傲”，额，有点扩张，不过自认为还说得过去的 feature，结果临上线前被啪啪打脸，因为实现过程中因为<strong>一行代码</strong>（没有标题党，真的是一行代码）带来的安全漏洞让我们丢失了整个服务器控制权（测试环境）。多亏了上线之前有公司安全团队的人会对代码进行扫描，才让这个漏洞被扼杀在摇篮里。</p>
<p>下面我们就一起来看看这个事故，啊，不对，是故事。</p>
<p><img src="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/gif-0.png" alt></p>
<h2 id="背景说明"><a href="#背景说明" class="headerlink" title="背景说明"></a>背景说明</h2><p>我们的项目是一个面向全球用户的 Web 项目，用 SpringBoot 开发。在项目开发过程中，离不开各种异常信息的处理，比如表单提交参数不符合预期，业务逻辑的处理时离不开各种异常信息（例如网络抖动等）的处理。于是利用 SpringBoot 各种现成的组件支持，设计了一个统一的异常信息处理组件，统一管理各种业务流程中可能出现的错误码和错误信息，通过国际化的资源配置文件进行统一输出给用户。</p>
<h3 id="统一错误信息配置管理"><a href="#统一错误信息配置管理" class="headerlink" title="统一错误信息配置管理"></a>统一错误信息配置管理</h3><p>我们的用户遍布全球，为了给各个国家用户比较好的体验会进行不同的翻译。具体而言，实现的效果如下，为了方便理解，以“找回登录密码”这样一个业务场景来进行阐述说明。</p>
<p>假设找回密码时，需要用户输入手机或者邮箱验证码，假设这个时候用户输入的验证码通过后台数据库（可能是Redis）对比发现已经过期。在业务代码中，只需要简单的 <code>throw new ErrorCodeException(ErrorCodes.AUTHCODE_EXPIRED)</code> 即可。具体而言，针对不同国家地区不同的语言看到的效果不一样：</p>
<ul>
<li>中文用户看到的提示就是“您输入的验证码已过期，请重新获取”；</li>
<li>欧美用户看到的效果是“The verification code you input is expired, …”；</li>
<li>德国用户看到的是：“Der von Ihnen eingegebene Verifizierungscode ist abgelaufen, bitte wiederholen” 。（我瞎找的翻译，不一定准）</li>
<li>……</li>
</ul>
<h3 id="统一错误信息配置管理代码实现"><a href="#统一错误信息配置管理代码实现" class="headerlink" title="统一错误信息配置管理代码实现"></a>统一错误信息配置管理代码实现</h3><p>关键信息其实就在于一个 GlobalExceptionHandler，对所有Controller 入口进行 AOP 拦截，根据不同的错误信息，获取相应资源文件配置的 key，并从语言资源文件中读取不同国家的错误翻译信息。 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalExceptionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(BadRequestException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    @<span class="title">ResponseBody</span></span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">ResponseEntity</span> <span class="title">handle</span>(<span class="title">HttpServletRequest</span> <span class="title">request</span>, <span class="title">BadRequestException</span> <span class="title">e</span>)</span>&#123;</span><br><span class="line">        String i18message = getI18nMessage(e.getKey(), request);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Response.error(e.getCode(), i18message));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(ErrorCodeException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    @<span class="title">ResponseBody</span></span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">ResponseEntity</span> <span class="title">handle</span>(<span class="title">HttpServletRequest</span> <span class="title">request</span>, <span class="title">ErrorCodeException</span> <span class="title">e</span>)</span>&#123;</span><br><span class="line">        String i18message = getI18nMessage(e.getKey(), request);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.OK).body(Response.error(e.getCode(), i18message));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.tanglei.name/resources/custom-validator-and-i18n-error-message-in-springboot/i18n-tree.png" alt="不同语言的资源文件示例"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getI18nMessage</span><span class="params">(String key, HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> messageSource.getMessage(key, <span class="keyword">null</span>, LanguaggeUtils.currentLocale(request));</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">       <span class="comment">// log</span></span><br><span class="line">       <span class="keyword">return</span> key;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>详细代码实现可以参考本人之前写的这篇文章<a href="/blog/custom-validator-and-i18n-error-message-in-springboot.html">一文教你实现 SpringBoot 中的自定义 Validator 和错误信息国际化配置</a>，上面有附完整的代码实现。</p>
<h3 id="基于注解的表单校验（含自定义注解）"><a href="#基于注解的表单校验（含自定义注解）" class="headerlink" title="基于注解的表单校验（含自定义注解）"></a>基于注解的表单校验（含自定义注解）</h3><p>还有一种常见的业务场景就是后端接口需要对用户提交的表单进行校验。以“注册用户”这样的场景举例说明， 注册用户时，往往会提交昵称，性别，邮箱等信息进行注册，简单起见，就以这 3 个属性为例。</p>
<p>定义的表单如下：  </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRegForm</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String nickname;</span><br><span class="line">	<span class="keyword">private</span> String gender;</span><br><span class="line">	<span class="keyword">private</span> String email;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于表单的约束，我们有：</p>
<ul>
<li>昵称字段：“nickname” 必填，长度必须是 6 到 20 位；</li>
<li>性别字段：“gender” 可选，如果填了，就必须是“Male/Female/Other/”中的一种。说啥，除了男女还有其他？对，是的。毕竟全球用户嘛，你去看看非死不可，还有更多。</li>
<li>邮箱： “email”，必填，必须满足邮箱格式。</li>
</ul>
<p>对于以上约束，我们只需要在对应的字段上添加如下注解即可。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRegForm</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Length</span>(min = <span class="number">6</span>, max = <span class="number">20</span>, message = <span class="string">"validate.userRegForm.nickname"</span>)</span><br><span class="line">	<span class="keyword">private</span> String nickname;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Gender</span>(message=<span class="string">"validate.userRegForm.gender"</span>)</span><br><span class="line">	<span class="keyword">private</span> String gender;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@NotNull</span></span><br><span class="line">	<span class="meta">@Email</span>(message=<span class="string">"validate.userRegForm.email"</span>)</span><br><span class="line">	<span class="keyword">private</span> String email;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在各个语言资源文件中配置好相应的错误信息提示即可。其中， <code>@Gender</code> 就是一个自定义的注解。</p>
<h3 id="基于含自定义注解的表单校验关键代码"><a href="#基于含自定义注解的表单校验关键代码" class="headerlink" title="基于含自定义注解的表单校验关键代码"></a>基于含自定义注解的表单校验关键代码</h3><p>自定义注解的实现主要的其实就是一个自定义注解的定义以及一个校验逻辑。<br>例如定义一个自定义注解 <code>CustomParam</code>： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Constraint</span>(validatedBy = CustomValidator<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">Target</span>(</span>&#123;FIELD, METHOD, PARAMETER, ANNOTATION_TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> CustomParam &#123;</span><br><span class="line">    <span class="function">String <span class="title">message</span><span class="params">()</span> <span class="keyword">default</span> "name.tanglei.www.validator.CustomArray.defaultMessage"</span>;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt;[] groups() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    Class&lt;? extends Payload&gt;[] payload() <span class="keyword">default</span> &#123; &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Documented</span></span><br><span class="line">    <span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line">    <span class="meta">@Target</span>(&#123;FIELD, METHOD, PARAMETER, ANNOTATION_TYPE&#125;)</span><br><span class="line">    <span class="meta">@interface</span> List &#123;</span><br><span class="line">        CustomParam[] value();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>校验逻辑的实现 <code>CustomValidator</code>： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomValidator</span> <span class="keyword">implements</span> <span class="title">ConstraintValidator</span>&lt;<span class="title">CustomParam</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(String s, ConstraintValidatorContext constraintValidatorContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == s || s.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (s.equals(<span class="string">"tanglei"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            error(constraintValidatorContext, <span class="string">"Invalid params: "</span> + s);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(CustomParam constraintAnnotation)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(ConstraintValidatorContext context, String message)</span> </span>&#123;</span><br><span class="line">        context.disableDefaultConstraintViolation();</span><br><span class="line">        context.buildConstraintViolationWithTemplate(message).addConstraintViolation();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面例子只为了阐述说明问题，其中校验逻辑没有实际意义，这样，如果输入参数不满足条件，就会明确提示用户输入的哪个参数不满足条件。例如输入参数 <code>xx</code>，则会直接提示：<code>Invalid params: xx</code>。</p>
<p><img src="https://www.tanglei.name/resources/custom-validator-and-i18n-error-message-in-springboot/validator-bug.png" alt></p>
<p>这个跟第一部分的处理方式类似，因为现有的 validator 组件实现中，如果违反相应的约束也是一种抛异常的方式实现的，因此只需要在上述的 <code>GlobalExceptionHandler</code>中添加相应的异常信息即可，这里就不详述了。  这不是本文的重点，这里就不详细阐述了。 详细代码实现可以参考本人之前写的这篇文章<a href="/blog/custom-validator-and-i18n-error-message-in-springboot.html">一文教你实现 SpringBoot 中的自定义 Validator 和错误信息国际化配置</a>，上面有附完整的代码实现。</p>
<h2 id="场景重现"><a href="#场景重现" class="headerlink" title="场景重现"></a>场景重现</h2><p>一切都显得很完美，直到上线前代码提交至安全团队扫描，就被“啪啪打脸”，扫描报告反馈了一个严重的安全漏洞。而这个安全漏洞，属于很高危的远程代码执行漏洞。</p>
<p><img src="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/gif-1.gif" alt></p>
<p>用前文提到的自定义 Validator，输入的参数用： “1+1=${1+1}”，看看效果： </p>
<p><img src="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/security-bug-calc-4wx.png" alt></p>
<p>太 TM 神奇了，居然帮我运算出来了，返回 <code>&quot;message&quot;: &quot;Invalid params: 1+1=2&quot;</code>。 </p>
<p>问题就出现在实现自定义注解进行校验的这行代码（如下图所示）：</p>
<p><img src="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/security-bug-line-4wx.png" alt></p>
<p>其实，最开始的时候，这里直接返回了“Invalid params”，当初为了更好的用户体验，要明确告诉用户哪个参数没有通过校验，因此在输出的提示上加上了用户输入的字段，也就是上面的<code>&quot;Invalid params: &quot; + s</code>，没想到，这闯了大祸了（回过头来想，感觉这里没必要这么详细啊，因为前端已经有相应的校验了，正常情况下回拦住，针对不守规矩的用非常规手段来的接口请求，直接返回校验不通过就行了，毕竟不是对外提供的 OpenAPI 服务）。</p>
<p>仔细看，这个方法实际上是 <code>ConstraintValidatorContext</code>这个接口中声明的，看方法名字其实能知道输入参数是一个字符串模板，内部会进行解析替换的（这其实也符合“见名知意”的良好编程习惯）。（教训：<strong>大家应该把握好自己写的每一行代码背后实际在做什么</strong>。）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* ......</span></span><br><span class="line"><span class="comment"> * @param messageTemplate new un-interpolated constraint message</span></span><br><span class="line"><span class="comment"> * @return returns a constraint violation builder</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">ConstraintViolationBuilder <span class="title">buildConstraintViolationWithTemplate</span><span class="params">(String messageTemplate)</span></span>;</span><br></pre></td></tr></table></figure>
<p>这个 case，源码调试进去之后，就能跟踪到执行翻译阶段，在如下方法中： <code>org.hibernate.validator.messageinterpolation.AbstractMessageInterpolator.interpolateMessage</code>。  </p>
<p><img src="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/security-bug-interpolate-4wx.png" alt></p>
<p>再往后，就是表达式求值了。<br><img src="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/security-bug-plus11-4wx.png" alt></p>
<h3 id="以为就这样就完了吗？"><a href="#以为就这样就完了吗？" class="headerlink" title="以为就这样就完了吗？"></a>以为就这样就完了吗？</h3><p><img src="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/gif-2.jpeg" alt></p>
<p>刚开始感觉，能帮忙算简单的运算规则也就完了吧，你还能把我怎么样？其实这个相当于暴露了一个入口，支持用户输入任意 EL 表达式进行执行。网上通过关键字 “SpEL表达式注入漏洞” 找找，就能发现事情并没有想象中那么简单。</p>
<p>我们构造恰当的 EL 表达式（注意各种转义，下文的输入参数相对比较明显在做什么了，实际上还有更多黑科技，比如各种二进制转义编码啊等等），就能直接执行输入代码，例如：可以直接执行命令，“ls -al”， 返回了一个 UNIXProcess 实例，命令已经被执行过了。</p>
<p><img src="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/security-bug-run-process-4wx.png" alt></p>
<p>比如，我们执行个打开计算器的命令，搞个计算器玩玩~ </p>
<p><img src="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/security-bug-run-open-calc-4wx.png" alt></p>
<p>我录制了一个动图，来个演示可能更生动一些。 </p>
<p><img src="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/spel-bug-demo-0.gif" alt></p>
<p>这还得了吗？这相当于提供了一个 webshell 的功能呀，你看想运行啥命令就能运行啥命令，例如 ping 本人博客地址（<code>ping www.tanglei.name</code>），下面动图演示一下整个过程（从运行 ping 到 kill ping）。</p>
<p><img src="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/spel-demo-ping.gif" alt></p>
<p>我录制了一个视频，点击<a href="http://mp.weixin.qq.com/s?__biz=MzI3OTUzMzcwNw==&amp;mid=100001493&amp;idx=1&amp;sn=d8d2374d8afa76e55bd37650c7ccde45&amp;chksm=6b4707315c308e273f4eb62799c65677d849104125bb6e7a56fbded981554fb92e97c289804e#rd" target="_blank" rel="noopener">这里</a>可以访问。</p>
<p>岂不是直接创建一个用户，然后远程登录就可以了。后果很严重啊，别人想干嘛就干嘛了。 </p>
<p><img src="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/gif-3.gif" alt></p>
<p>我们跟踪下对应的代码，看看内部实现，就会“恍然大悟”了。 </p>
<p><img src="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/security-bug-el-express-4wx.png" alt></p>
<p><img src="https://www.tanglei.name/resources/a-security-vulnerability-of-spring-validator/security-bug-el-express-run-4wx.png" alt></p>
<h2 id="经验教训"><a href="#经验教训" class="headerlink" title="经验教训"></a>经验教训</h2><p>幸亏这个漏洞被扼杀在摇篮里，否则后果还真的挺严重的。通过这个案例，我们有啥经验和教训呢？那就是作为程序员，<strong>我们要对每一行代码都保持“敬畏”之心</strong>。也许就是因为你的不经意的一行代码就带来了严重的安全漏洞，要是不小心被坏人利用，轻则……重则……（自己想象吧） </p>
<p>此外，我们也应该看到，程序员需要对常见的安全漏洞（例如XSS/CSRF/SQL注入等等）有所了解，并且要有足够的安全意识（其实有时候研究一些安全问题还挺好玩的，比如这篇<a href="http://mp.weixin.qq.com/s?__biz=MzI3OTUzMzcwNw==&amp;mid=2247483759&amp;idx=1&amp;sn=9b37547a51ac99a8d3d50cb9cf54a99a&amp;chksm=eb47008bdc30899dace5743edfc071d97d37764ed69bd9cebbfe32c14727a7407a6b8b76a433&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">《RSA算法及一种”旁门左道”的攻击方式》</a>就比较有趣）。例如：</p>
<ul>
<li>用户权限分离：运行程序的用户不应该用 root，例如新建一个“web”或者“www”之类的用户，并设置该用户的权限，比如不能有可执行 xx 的权限之类的。本文 case，如果权限进行了分离（遵循最小权限原则），应该也不会这么严重。（本文就刚好是因为是测试环境，所以没有强制实施）</li>
<li>任何时候都不要相信用户的输入，必须对用户输入的进行校验和过滤，又特别是针对公网上的应用。</li>
<li>敏感信息加密保存。退一万步讲，假设攻击者攻入了你的服务器，如果这个时候，你的数据库账户信息等配置都直接明文保存在服务器中。那数据库也被脱走了。</li>
</ul>
<p>如果可能的话，需要对开发者的代码进行漏洞扫描。一些常见的安全漏洞现在应该是有现成的工具支持的。另外，让专业的人做专业的事情，例如要有安全团队，可能你会说你们公司没有不也活的好好的，哈哈，只不过可能还没有被坏人盯上而已，坏人也会考虑到他们的成本和预期收益的，当然这就更加对我们开发者提高了要求。一些敏感权限尽量控制在少部分人手中，配合相应的流程来支撑（不得不说，大公司繁琐的流程还是有一定道理的）。</p>
<p>毕竟我不是专业研究Web安全的，以上说得可能也不一定对，如果你有不同意见或者更好的建议欢迎留言参与讨论。</p>
<p>这篇文章从写代码做实验，到录屏做视频动图等等耗时还蛮久的（好几个周末的时间呢），原创真心不易，希望你能帮我个小忙呗，如果本文内容你觉得有所启发，有所收获，请帮忙点个“在看”呗，或者转发分享让更多的小伙伴看到。</p>
<h5 id="精彩推荐"><a href="#精彩推荐" class="headerlink" title="精彩推荐"></a>精彩推荐</h5><ul>
<li><a href="http://mp.weixin.qq.com/s?__biz=MzI3OTUzMzcwNw==&amp;mid=2247483933&amp;idx=1&amp;sn=69b1be012cf37ccb5ce6f3a091f57f5b&amp;chksm=eb4703f9dc308aef5834a6abf72255edd1767e633330531f817d7b4774c65c33f5910cd9ea75&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">一个由跨平台产生的浮点数bug | 有你意想不到的结果。</a></li>
<li><a href="http://mp.weixin.qq.com/s?__biz=MzI3OTUzMzcwNw==&amp;mid=2247483759&amp;idx=1&amp;sn=9b37547a51ac99a8d3d50cb9cf54a99a&amp;chksm=eb47008bdc30899dace5743edfc071d97d37764ed69bd9cebbfe32c14727a7407a6b8b76a433&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">RSA算法及一种”旁门左道”的攻击方式。</a></li>
<li><a href="http://mp.weixin.qq.com/s?__biz=MzI3OTUzMzcwNw==&amp;mid=2247483891&amp;idx=1&amp;sn=264171adf872514d1fd54faf54970dd7&amp;chksm=eb470017dc3089019ffc13facfdfb38e9d5f2adaf7fcbf9c117723ce015fb660f0802d406c7b&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">震惊! 阿里的程序员也不过如此,竟被一个简单的 SQL 查询难住。</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzI3OTUzMzcwNw==&amp;mid=2247483912&amp;idx=1&amp;sn=520bbca6a2056ab4df6b0e1d0ebaf6e0&amp;chksm=eb4703ecdc308afa83b288b1469f0927c1916189f219ee5e8c3c5194defc0b8f313ff7607730&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">面了7轮 Google，最终还是逃不脱被挂的命运。</a></li>
</ul>
<blockquote>
<p>文章首发于本人微信公众号（ID：<code>tangleithu</code>），请感兴趣的同学关注我的微信公众号，及时获取技术干货。</p>
</blockquote>

      
    </div>

    <div>
      
        
<div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="/resources/wechat-tangleithu-codershitou.jpg" alt="tanglei wechat" style="width: 400px; max-width: 100%;">
    <div>欢迎扫码加入互联网大厂内推群 & 技术交流群，一起学习、共同进步</div>
</div>


      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/经验技巧/" rel="tag"># 经验技巧</a>
          
            <a href="/tags/Java/" rel="tag"># Java</a>
          
            <a href="/tags/网络安全/" rel="tag"># 网络安全</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/custom-validator-and-i18n-error-message-in-springboot.html" rel="next" title="一文教你实现 SpringBoot 中的自定义 Validator 和错误信息国际化配置">
                <i class="fa fa-chevron-left"></i> 一文教你实现 SpringBoot 中的自定义 Validator 和错误信息国际化配置
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/blog/architecture-evolution-of-HA-system-of-buy-facemask.html" rel="prev" title="高并发口罩抢购项目架构演进记录&优化经验分享">
                高并发口罩抢购项目架构演进记录&优化经验分享 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/tx.jpg" alt="tanglei">
          <p class="site-author-name" itemprop="name">tanglei</p>
          <p class="site-description motion-element" itemprop="description">码农 @ 阿里云, 毕业于CSU && THU,  曾工作于大疆(DJI), 宜信大数据创新中心, <a href="http://www.tencent.com/zh-cn/index.shtml" target="_blank">腾讯</a> && <a href="http://www.umeng.com/" target="_blank">友盟</a>.  &nbsp; <a href="/about/"> MORE </a></p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">481</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">151</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="/resources/tl3shi-wechat.png" target="_blank" title="Wechat">
                  
                    <i class="fa fa-fw fa-weixin"></i>
                  
                  Wechat
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/tl3shi" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/tangleithu" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#背景说明"><span class="nav-number">1.</span> <span class="nav-text">背景说明</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#统一错误信息配置管理"><span class="nav-number">1.1.</span> <span class="nav-text">统一错误信息配置管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#统一错误信息配置管理代码实现"><span class="nav-number">1.2.</span> <span class="nav-text">统一错误信息配置管理代码实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#基于注解的表单校验（含自定义注解）"><span class="nav-number">1.3.</span> <span class="nav-text">基于注解的表单校验（含自定义注解）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#基于含自定义注解的表单校验关键代码"><span class="nav-number">1.4.</span> <span class="nav-text">基于含自定义注解的表单校验关键代码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#场景重现"><span class="nav-number">2.</span> <span class="nav-text">场景重现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#以为就这样就完了吗？"><span class="nav-number">2.1.</span> <span class="nav-text">以为就这样就完了吗？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#经验教训"><span class="nav-number">3.</span> <span class="nav-text">经验教训</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#精彩推荐"><span class="nav-number">3.0.0.1.</span> <span class="nav-text">精彩推荐</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2010 - 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">tanglei</span>
   
  <span class="author" itemprop="copyrightHolder">
      - 渝ICP备16013386号 
  </span>
 
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'hexo-tanglei';
      var disqus_identifier = 'blog/a-security-vulnerability-of-spring-validator.html';

      var disqus_title = "一行代码引来的安全漏洞就让我们丢失了整个服务器的控制权";


      function run_disqus_script(disqus_script) {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');

      
        var disqus_config = function () {
            this.page.url = disqus_url;
            this.page.identifier = disqus_identifier;
            this.page.title = disqus_title;
        };
        run_disqus_script('embed.js');
      

    </script>
  







  
  

  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  


</body>
</html>
