# è¿™ 10 è¡Œæ¯”è¾ƒå­—ç¬¦ä¸²ç›¸ç­‰çš„ä»£ç ç»™æˆ‘æ•´æ‡µé€¼äº†ï¼Œä¸ä¿¡ä½ ä¹Ÿæ¥çœ‹çœ‹


æŠ±æ­‰ç”¨è¿™ç§æ ‡é¢˜å¸å¼•ä½ ç‚¹è¿›æ¥äº†ï¼Œä¸è¿‡ä½ ä¸å¦¨çœ‹å®Œï¼Œçœ‹çœ‹èƒ½å¦è®©ä½ æœ‰æ‰€æ”¶è·ã€‚â€‹ï¼ˆæœ‰æ”¶è·ï¼Œè¯·è¯„è®ºåŒºç•™ä¸ªè¨€ï¼Œæ²¡æ”¶è·ï¼Œä¸‹å‘¨æœ«æˆ‘ç›´æ’­åƒ**ï¼Œå“ˆå“ˆï¼Œè¿™ä½ ä¹Ÿä¿¡ï¼‰

>è¡¥å……è¯´æ˜ï¼šå¾®ä¿¡å…¬ä¼—å·æ”¹ç‰ˆï¼Œå¯¹å„ä¸ªå·ä¸»å½±å“è¿˜æŒºå¤§çš„ã€‚ç›®å‰ä»åå°æ•°æ®æ¥çœ‹ï¼Œå¯¹æˆ‘å½±å“ä¸å¤§ï¼Œå› ä¸ºæˆ‘è¿™åæ­£éƒ½æ˜¯å°å·ï¼ŒğŸ˜‚é˜…è¯»é‡æœ¬èº«å°±å°‘çš„å¯æ€œï¼ŒçœŸç›¸äº†ï¼ŒğŸ¶ç‹—å¤´ï¼ˆåˆšä»äº¤æµç¾¤å­¦ä¼šçš„è¡¨æƒ…ï¼‰ã€‚

å…ˆç›´æ¥ä¸Šä»£ç ï¼š 

```java
boolean safeEqual(String a, String b) {
   if (a.length() != b.length()) {
       return false;
   }
   int equal = 0;
   for (int i = 0; i < a.length(); i++) {
       equal |= a.charAt(i) ^ b.charAt(i);
   }
   return equal == 0;
}
```

ä¸Šé¢çš„ä»£ç æ˜¯æˆ‘æ ¹æ®åŸç‰ˆï¼ˆ`Scala`ï¼‰ç¿»è¯‘æˆ `Java`çš„ï¼Œ`Scala` ç‰ˆæœ¬ï¼ˆæœ€å¼€å§‹å¸å¼•ç¨‹åºçŒ¿çŸ³å¤´æ³¨æ„åŠ›çš„ä»£ç ï¼‰å¦‚ä¸‹ï¼š

```scala
def safeEqual(a: String, b: String) = {
  if (a.length != b.length) {
    false
  } else {
    var equal = 0
    for (i <- Array.range(0, a.length)) {
      equal |= a(i) ^ b(i)
    }
    equal == 0
  }
}
```

åˆšå¼€å§‹çœ‹åˆ°è¿™æ®µæºç æ„Ÿè§‰æŒºå¥‡æ€ªçš„ï¼Œè¿™ä¸ªå‡½æ•°çš„åŠŸèƒ½æ˜¯æ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ç›¸ç­‰ï¼Œé¦–å…ˆâ€œé•¿åº¦ä¸ç­‰ç»“æœè‚¯å®šä¸ç­‰ï¼Œç«‹å³è¿”å›â€è¿™ä¸ªå¾ˆå¥½ç†è§£ã€‚

å†çœ‹çœ‹åé¢çš„ï¼Œç¨å¾®åŠ¨ä¸‹è„‘ç­‹ï¼Œè½¬å¼¯ä¸‹ä¹Ÿèƒ½æ˜ç™½è¿™å…¶ä¸­çš„é—¨é“ï¼šé€šè¿‡å¼‚æˆ–æ“ä½œ`1^1=0, 1^0=1, 0^0=0`ï¼Œæ¥æ¯”è¾ƒæ¯ä¸€ä½ï¼Œå¦‚æœæ¯ä¸€ä½éƒ½ç›¸ç­‰çš„è¯ï¼Œä¸¤ä¸ªå­—ç¬¦ä¸²è‚¯å®šç›¸ç­‰ï¼Œæœ€åå­˜å‚¨ç´¯è®¡å¼‚æˆ–å€¼çš„å˜é‡`equal`å¿…å®šä¸º 0ï¼Œå¦åˆ™ä¸º 1ã€‚

## å†ç»†æƒ³ä¸€ä¸‹å‘¢ï¼Ÿ

```scala
for (i <- Array.range(0, a.length)) {
  if (a(i) ^ b(i) != 0) // or a(i) != b[i]
    return false
}
```

æˆ‘ä»¬å¸¸å¸¸è®²æ€§èƒ½ä¼˜åŒ–ï¼Œä»æ•ˆç‡è§’åº¦ä¸Šè®²ï¼Œéš¾é“ä¸æ˜¯åº”è¯¥åªè¦ä¸­é€”å‘ç°æŸä¸€ä½çš„ç»“æœä¸åŒäº†ï¼ˆå³ä¸º1ï¼‰å°±å¯ä»¥ç«‹å³è¿”å›ä¸¤ä¸ªå­—ç¬¦ä¸²ä¸ç›¸ç­‰äº†å—ï¼Ÿ(å¦‚ä¸Šæ‰€ç¤º) 

è¿™å…¶ä¸­è‚¯å®šæœ‰â€¦â€¦

![](https://imgkr.cn-bj.ufileos.com/0d90724a-9e67-42ff-9db5-53453fba1abf.png)


## å†å†ç»†æƒ³ä¸€ä¸‹å‘¢ï¼Ÿ
 
ç»“åˆæ–¹æ³•åç§° `safeEquals` å¯èƒ½çŸ¥é“äº›çœ‰ç›®ï¼Œä¸å®‰å…¨æœ‰å…³ã€‚

>æœ¬æ–‡å¼€ç¯‡çš„ä»£ç æ¥è‡ªplayframewok é‡Œç”¨æ¥éªŒè¯cookie(session)ä¸­çš„æ•°æ®æ˜¯å¦åˆæ³•(åŒ…å«ç­¾åçš„éªŒè¯)ï¼Œä¹Ÿæ˜¯çŸ³å¤´å†™è¿™ç¯‡æ–‡ç« çš„ç”±æ¥ã€‚

ä»¥å‰çŸ¥é“é€šè¿‡å»¶è¿Ÿè®¡ç®—ç­‰æ‰‹æ®µæ¥æé«˜æ•ˆç‡çš„æ‰‹æ®µï¼Œä½†è¿™ç§å·²ç»ç®—å‡ºç»“æœå´å»¶è¿Ÿè¿”å›çš„ï¼Œè¿˜æ˜¯å¤´ä¸€å›ï¼

æˆ‘ä»¬æ¥çœ‹çœ‹ï¼ŒJDK ä¸­ä¹Ÿæœ‰ç±»ä¼¼çš„æ–¹æ³•ï¼Œå¦‚ä¸‹ä»£ç æ‘˜è‡ª `java.security.MessageDigest`ï¼š

```java
public static boolean isEqual(byte[] digesta, byte[] digestb) {
   if (digesta == digestb) return true;
   if (digesta == null || digestb == null) {
       return false;
   }
   if (digesta.length != digestb.length) {
       return false;
   }

   int result = 0;
   // time-constant comparison
   for (int i = 0; i < digesta.length; i++) {
       result |= digesta[i] ^ digestb[i];
   }
   return result == 0;
}
```

çœ‹æ³¨é‡ŠçŸ¥é“äº†ï¼Œç›®çš„æ˜¯ä¸ºäº†ç”¨å¸¸é‡æ—¶é—´å¤æ‚åº¦è¿›è¡Œæ¯”è¾ƒã€‚

ä½†è¿™ä¸ªè®¡ç®—è¿‡ç¨‹è€—è´¹çš„æ—¶é—´ä¸æ˜¯å¸¸é‡æœ‰å•¥é£é™©ï¼Ÿ ï¼ˆè„‘æµ·é‡Œå“èµ·äº†èƒŒæ™¯éŸ³ä¹ï¼šâ€œå°æœ‹å‹ï¼Œä½ æ˜¯å¦æœ‰å¾ˆå¤šé—®å·ï¼Ÿâ€ï¼‰

![](https://imgkr.cn-bj.ufileos.com/327a7a80-6fd7-4b4f-b836-78fc9399ce34.png)


## çœŸç›¸å¤§ç™½

å†æ·±å…¥æ¢ç´¢å’Œäº†è§£äº†ä¸€ä¸‹ï¼ŒåŸæ¥è¿™ä¹ˆåšæ˜¯ä¸ºäº†é˜²æ­¢**è®¡æ—¶æ”»å‡»**ï¼ˆTiming Attackï¼‰ã€‚ï¼ˆä¹Ÿæœ‰äººç¿»è¯‘æˆæ—¶åºæ”»å‡»â€‹ï¼‰â€‹

![](https://imgkr.cn-bj.ufileos.com/43ae6be8-c869-4bfa-bab9-77435893afb4.png)


## è®¡æ—¶æ”»å‡»(Timing Attack)

è®¡æ—¶æ”»å‡»æ˜¯è¾¹ä¿¡é“æ”»å‡»(æˆ–ç§°"ä¾§ä¿¡é“æ”»å‡»"ï¼Œ Side Channel Attackï¼Œ ç®€ç§°SCA) çš„ä¸€ç§ï¼Œè¾¹ä¿¡é“æ”»å‡»æ˜¯ä¸€ç§é’ˆå¯¹è½¯ä»¶æˆ–ç¡¬ä»¶è®¾è®¡ç¼ºé™·ï¼Œèµ°â€œæ­ªé—¨é‚ªé“â€çš„ä¸€ç§æ”»å‡»æ–¹å¼ã€‚

è¿™ç§æ”»å‡»æ–¹å¼æ˜¯é€šè¿‡åŠŸè€—ã€æ—¶åºã€ç”µç£æ³„æ¼ç­‰æ–¹å¼è¾¾åˆ°ç ´è§£ç›®çš„ã€‚åœ¨å¾ˆå¤šç‰©ç†éš”ç»çš„ç¯å¢ƒä¸­ï¼Œå¾€å¾€ä¹Ÿèƒ½å‡ºå¥‡åˆ¶èƒœï¼Œè¿™ç±»æ–°å‹æ”»å‡»çš„æœ‰æ•ˆæ€§**è¿œé«˜äº**ä¼ ç»Ÿçš„å¯†ç åˆ†æçš„æ•°å­¦æ–¹æ³•ï¼ˆæŸç™¾ç§‘ä¸Šè¯´çš„ï¼‰ã€‚

è¿™ç§æ‰‹æ®µå¯ä»¥è®©è°ƒç”¨ `safeEquals("abcdefghijklmn", "xbcdefghijklmn")` ï¼ˆåªæœ‰é¦–ä½ä¸ç›¸åŒï¼‰å’Œè°ƒç”¨ `safeEquals("abcdefghijklmn", "abcdefghijklmn")` ï¼ˆä¸¤ä¸ªå®Œå…¨ç›¸åŒçš„å­—ç¬¦ä¸²ï¼‰çš„æ‰€è€—è´¹çš„æ—¶é—´ä¸€æ ·ã€‚é˜²æ­¢é€šè¿‡å¤§é‡çš„æ”¹å˜è¾“å…¥å¹¶é€šè¿‡ç»Ÿè®¡è¿è¡Œæ—¶é—´æ¥æš´åŠ›ç ´è§£å‡ºè¦æ¯”è¾ƒçš„å­—ç¬¦ä¸²ã€‚ 

ä¸¾ä¸ªğŸŒ°ï¼Œå¦‚æœç”¨ä¹‹å‰è¯´çš„â€œé«˜æ•ˆâ€çš„æ–¹å¼æ¥å®ç°çš„è¯ã€‚å‡è®¾æŸä¸ªç”¨æˆ·è®¾ç½®äº†å¯†ç ä¸º `password`ï¼Œé€šè¿‡ä»aåˆ°zï¼ˆå®é™…èŒƒå›´å¯èƒ½æ›´å¹¿ï¼‰ä¸æ–­æšä¸¾ç¬¬ä¸€ä½ï¼Œæœ€ç»ˆç»Ÿè®¡å‘ç° `p0000000` çš„è¿è¡Œæ—¶é—´æ¯”å…¶ä»–ä»ä»»æ„`a~z`çš„éƒ½é•¿ï¼ˆå› ä¸ºè¦åˆ°ç¬¬äºŒä½æ‰èƒ½å‘ç°ä¸åŒï¼Œå…¶ä»–é `p` å¼€å¤´çš„å­—ç¬¦ä¸²ç¬¬ä¸€ä½ä¸åŒå°±ç›´æ¥è¿”å›äº†ï¼‰ï¼Œè¿™æ ·å°±èƒ½çŒœæµ‹å‡ºç”¨æˆ·å¯†ç çš„ç¬¬ä¸€ä½å¾ˆå¯èƒ½æ˜¯`p`äº†ï¼Œç„¶åå†ä¸æ–­ä¸€ä½ä¸€ä½è¿­ä»£ä¸‹å»æœ€ç»ˆç ´è§£å‡ºç”¨æˆ·çš„å¯†ç ã€‚

å½“ç„¶ï¼Œä»¥ä¸Šæ˜¯ä»ç†è®ºè§’åº¦åˆ†æï¼Œç¡®å®å®¹æ˜“ç†è§£ã€‚ä½†å®é™…ä¸Šå¥½åƒé€šè¿‡ç»Ÿè®¡è¿è¡Œæ—¶é—´æ€»æ„Ÿè§‰ä¸å¤ªé è°±ï¼Œè¿™ä¸ªè¿è¡Œæ—¶é—´å¯¹ç¯å¢ƒå¤ªæ•æ„Ÿäº†ï¼Œæ¯”å¦‚ç½‘ç»œï¼Œå†…å­˜ï¼ŒCPUè´Ÿè½½ç­‰ç­‰éƒ½ä¼šå½±å“ã€‚

ä½†å®‰å…¨é—®é¢˜æ„Ÿè§‰æ›´åƒæ˜¯ â€œå®å¯ä¿¡å…¶æœ‰ï¼Œä¸å¯ä¿¡å…¶æ— â€ã€‚ä¸ºäº†é˜²æ­¢(ç‰¹åˆ«æ˜¯ä¸ç­¾å/å¯†ç éªŒè¯ç­‰ç›¸å…³çš„æ“ä½œ)è¢« **timing attack**ï¼Œç›®å‰å„å¤§è¯­è¨€éƒ½æä¾›äº†ç›¸åº”çš„å®‰å…¨æ¯”è¾ƒå‡½æ•°ã€‚å„ç§è½¯ä»¶ç³»ç»Ÿï¼ˆä¾‹å¦‚ OpenSSLï¼‰ã€æ¡†æ¶ï¼ˆä¾‹å¦‚ Playï¼‰çš„å®ç°ä¹Ÿéƒ½é‡‡ç”¨äº†è¿™ç§æ–¹å¼ã€‚ 

ä¾‹å¦‚ â€œä¸–ç•Œä¸Šæœ€å¥½çš„ç¼–ç¨‹è¯­è¨€â€ï¼ˆç²‰ä¸è¾ƒå°‘ï¼Œè¯„è®ºåŒºåº”è¯¥æ‰“ä¸èµ·æ¶æ¥ï¼‰â€”â€” phpä¸­çš„: 

```php
// Compares two strings using the same time whether they're equal or not.
// This function should be used to mitigate timing attacks; 
// for instance, when testing crypt() password hashes.
bool hash_equals ( string $known_string , string $user_string )

//This function is safe against timing attacks.
boolean password_verify ( string $password , string $hash )
```

å…¶å®å„ç§è¯­è¨€ç‰ˆæœ¬çš„å®ç°æ–¹å¼éƒ½ä¸ä¸Šé¢çš„ç‰ˆæœ¬å·®ä¸å¤šï¼Œå°†ä¸¤ä¸ªå­—ç¬¦ä¸²æ¯ä¸€ä½å–å‡ºæ¥å¼‚æˆ–(`^`)å¹¶ç”¨æˆ–(`|`)ä¿å­˜ï¼Œæœ€åé€šè¿‡åˆ¤æ–­ç»“æœæ˜¯å¦ä¸º 0 æ¥ç¡®å®šä¸¤ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ç›¸ç­‰ã€‚ 

å¦‚æœåˆšå¼€å§‹æ²¡æœ‰ç”¨ `safeEquals` å»å®ç°ï¼Œåç»­çš„ç‰ˆæœ¬è¿˜ä¼šé€šè¿‡æ‰“è¡¥ä¸çš„æ–¹å¼å»ä¿®å¤è¿™æ ·çš„å®‰å…¨éšæ‚£ã€‚  

ä¾‹å¦‚ [JDK 1.6.0_17 ä¸­çš„Release Notes](http://www.oracle.com/technetwork/java/javase/6u17-141447.html "Release Notes")ä¸­å°±æåˆ°äº†`MessageDigest.isEqual` ä¸­çš„bugçš„ä¿®å¤ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![MessageDigest timing attack vulnerabilities](https://static01.imgkr.com/temp/7e264b6f9f6141e9a779f07bd29ebd64.png)

å¤§å®¶å¯ä»¥çœ‹çœ‹è¿™æ¬¡å˜æ›´çš„çš„è¯¦ç»†ä¿¡æ¯[openjdkä¸­çš„ bug fix diff](http://hg.openjdk.java.net/jdk6/jdk6/jdk/rev/562da0baf70b "openjdkä¸­çš„ bug fix diff")ä¸ºï¼š

![MessageDigest.isEqualè®¡æ—¶æ”»å‡»](https://static01.imgkr.com/temp/87adf41576964e8bafb2abf48c6a95ab.png)


## Timing Attack çœŸçš„å¯è¡Œå—ï¼Ÿ

æˆ‘è§‰å¾—å„å¤§è¯­è¨€çš„ API éƒ½ç”¨è¿™ç§å®ç°ï¼Œè‚¯å®šè¿˜æ˜¯æœ‰é“ç†çš„ï¼Œç†è®ºä¸Šåº”è¯¥å¯ä»¥è¢«åˆ©ç”¨çš„ã€‚ 
è¿™ä¸ï¼Œå­¦æœ¯ç•Œçš„è¿™ç¯‡è®ºæ–‡å°±å®£ç§°ç”¨è¿™ç§è®¡æ—¶æ”»å‡»çš„æ–¹æ³•ç ´è§£äº† `OpenSSL 0.9.7` çš„RSAåŠ å¯†ç®—æ³•äº†ã€‚å…³äº [RSA ç®—æ³•çš„ä»‹ç»](http://mp.weixin.qq.com/s?__biz=MzI3OTUzMzcwNw==&mid=100000109&idx=1&sn=e65143adf4f81cc5c559b03c58d029e9&chksm=6b4700895c30899f6148025c6120844bd0aeb2d09413ad4ece33f2ea49296fa6f54d17447f63#rd)å¯ä»¥çœ‹çœ‹ä¹‹å‰æœ¬äººå†™çš„è¿™ç¯‡æ–‡ç« ã€‚ 

è¿™ç¯‡[Remote Timing Attacks are Practical](http://crypto.stanford.edu/~dabo/papers/ssl-timing.pdf "Remote Timing Attacks are Practical") è®ºæ–‡ä¸­æŒ‡å‡ºï¼ˆæˆ‘å¤§è‡´ç¿»è¯‘ä¸‹æ‘˜è¦ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥é€šè¿‡æ–‡æœ«é“¾æ¥å»çœ‹åŸæ–‡ï¼‰ï¼š

è®¡æ—¶æ”»å‡»å¾€å¾€ç”¨äºæ”»å‡»ä¸€äº›æ€§èƒ½è¾ƒå¼±çš„è®¡ç®—è®¾å¤‡ï¼Œä¾‹å¦‚ä¸€äº›æ™ºèƒ½å¡ã€‚æˆ‘ä»¬é€šè¿‡å®éªŒå‘ç°ï¼Œä¹Ÿèƒ½ç”¨äºæ”»å‡»æ™®é€šçš„è½¯ä»¶ç³»ç»Ÿã€‚æœ¬æ–‡é€šè¿‡å®éªŒè¯æ˜ï¼Œé€šè¿‡è¿™ç§è®¡æ—¶æ”»å‡»æ–¹å¼èƒ½å¤Ÿæ”»ç ´ä¸€ä¸ªåŸºäº OpenSSL çš„ web æœåŠ¡å™¨çš„ç§é’¥ã€‚ç»“æœè¯æ˜è®¡æ—¶æ”»å‡»ç”¨äºè¿›è¡Œç½‘ç»œæ”»å‡»åœ¨å®è·µä¸­å¯è¡Œçš„ï¼Œå› æ­¤å„å¤§å®‰å…¨ç³»ç»Ÿéœ€è¦æŠµå¾¡è¿™ç§é£é™©ã€‚

æœ€åï¼Œæœ¬äººæ¯•ç«Ÿä¸æ˜¯ä¸“ç ”å®Œå…¨æ–¹å‘ï¼Œä»¥ä¸Šæè¿°æ˜¯åŸºäºæœ¬äººçš„ç†è§£ï¼Œå¦‚æœæœ‰ä¸å¯¹çš„åœ°æ–¹ï¼Œè¿˜è¯·å¤§å®¶ç•™è¨€æŒ‡å‡ºæ¥ã€‚æ„Ÿè°¢ã€‚

>è¡¥å……è¯´æ˜2ï¼šæ„Ÿè°¢æ­£åœ¨é˜…è¯»æ–‡ç« çš„ä½ ï¼Œè®©æˆ‘è¿˜æœ‰åŠ¨åŠ›ç»§ç»­åšæŒæ›´æ–°åŸåˆ›ã€‚
>
>æœ¬äººå‘æ–‡ä¸å¤šï¼Œä½†å¸Œæœ›å†™çš„æ–‡ç« èƒ½è¾¾åˆ°çš„ç›®çš„æ˜¯ï¼šå ç”¨ä½ çš„é˜…è¯»æ—¶é—´ï¼Œå°±å°½é‡èƒ½å¤Ÿè®©ä½ æœ‰æ‰€æ”¶è·ã€‚
>
>å¦‚æœä½ è§‰å¾—æˆ‘çš„æ–‡ç« æœ‰æ‰€å¸®åŠ©ï¼Œè¿˜è¯·ä½ å¸®å¿™è½¬å‘åˆ†äº«ï¼Œå¦å¤–è¯·åˆ«å¿˜äº†ç‚¹å‡»å…¬ä¼—å·å³ä¸Šè§’åŠ ä¸ªæ˜Ÿæ ‡ï¼Œå¥½è®©ä½ åˆ«é”™è¿‡åç»­çš„ç²¾å½©æ–‡ç« ï¼ˆå¾®ä¿¡æ”¹ç‰ˆäº†ï¼Œæˆ–è®¸æˆ‘å‘çš„æ–‡ç« éƒ½ä¸èƒ½æ¨é€åˆ°ä½ é‚£äº†ï¼‰ã€‚

â€‹åŸåˆ›çœŸå¿ƒä¸æ˜“ï¼Œå¸Œæœ›ä½ èƒ½å¸®æˆ‘ä¸ªå°å¿™å‘—ï¼Œå¦‚æœæœ¬æ–‡å†…å®¹ä½ è§‰å¾—æœ‰æ‰€å¯å‘ï¼Œæœ‰æ‰€æ”¶è·ï¼Œè¯·å¸®å¿™ç‚¹ä¸ªâ€œåœ¨çœ‹â€å‘—ï¼Œæˆ–è€…è½¬å‘åˆ†äº«è®©æ›´å¤šçš„å°ä¼™ä¼´çœ‹åˆ°ã€‚ 
â€‹
å‚è€ƒèµ„æ–™ï¼š

- [Timing Attacks on RSA: Revealing Your Secrets through the Fourth Dimension](http://www.cs.sjsu.edu/faculty/stamp/students/article.html)
- [Remote Timing Attacks are Practical](http://crypto.stanford.edu/~dabo/papers/ssl-timing.pdf) 

